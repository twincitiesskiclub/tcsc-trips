{% extends 'admin/admin_base.html' %}
{% block extra_css %}
<style>
/* Status badge colors */
.status-ACTIVE, .status-active, .status-success {
    background: rgb(34 197 94 / 0.15);
    color: rgb(21 128 61);
}

.status-PENDING, .status-pending, .status-PENDING_LOTTERY, .status-requires_capture {
    background: rgb(251 191 36 / 0.2);
    color: rgb(180 83 9);
}

.status-ALUMNI, .status-info {
    background: rgb(59 130 246 / 0.15);
    color: rgb(29 78 216);
}

.status-DROPPED, .status-canceled, .status-refunded {
    background: rgb(239 68 68 / 0.15);
    color: rgb(153 27 27);
}

.status-processing {
    background: rgb(168 85 247 / 0.15);
    color: rgb(107 33 168);
}

.status-unknown {
    background: rgb(113 113 122 / 0.1);
    color: rgb(63 63 70);
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <h1 class="text-2xl font-semibold text-tcsc-navy m-0">{{ user.full_name }}</h1>
        <div class="flex gap-3">
            <a href="{{ url_for('admin.get_admin_users') }}" class="bg-gray-200 text-gray-600 px-4 py-2.5 rounded-tcsc text-sm font-medium transition-all hover:bg-gray-300 inline-flex items-center">Back to List</a>
            <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="bg-tcsc-navy text-white px-4 py-2.5 rounded-tcsc text-sm font-medium transition-all hover:opacity-90 inline-flex items-center">Edit Member</a>
        </div>
    </div>

    <!-- Info Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8">
        <!-- Contact Information -->
        <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
            <h3 class="m-0 mb-4 text-tcsc-navy text-base font-semibold border-b border-tcsc-gray-100 pb-2">Contact Information</h3>
            <dl class="m-0">
                <dt class="font-medium text-tcsc-gray-600 text-sm">Email</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.email }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Phone</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.phone or '-' }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Address</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.address or '-' }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Slack UID</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.slack_user.slack_uid if user.slack_user else '-' }}</dd>
            </dl>
        </div>

        <!-- Profile -->
        <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
            <h3 class="m-0 mb-4 text-tcsc-navy text-base font-semibold border-b border-tcsc-gray-100 pb-2">Profile</h3>
            <dl class="m-0">
                <dt class="font-medium text-tcsc-gray-600 text-sm">Status</dt>
                <dd class="m-0 mt-1 text-tcsc-navy"><span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-{{ user.status }}">{{ user.status }}</span></dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Member Type</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ 'Returning' if user.is_returning else 'New' }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Pronouns</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.pronouns or '-' }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Date of Birth</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.date_of_birth.strftime('%Y-%m-%d') if user.date_of_birth else '-' }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Member Since</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.created_at.strftime('%b %d, %Y') if user.created_at else '-' }}</dd>
            </dl>
        </div>

        <!-- Skiing Info -->
        <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
            <h3 class="m-0 mb-4 text-tcsc-navy text-base font-semibold border-b border-tcsc-gray-100 pb-2">Skiing Info</h3>
            <dl class="m-0">
                <dt class="font-medium text-tcsc-gray-600 text-sm">Preferred Technique</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.preferred_technique or '-' }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Experience</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.ski_experience or '-' }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">T-Shirt Size</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.tshirt_size or '-' }}</dd>
            </dl>
        </div>

        <!-- Emergency Contact -->
        <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
            <h3 class="m-0 mb-4 text-tcsc-navy text-base font-semibold border-b border-tcsc-gray-100 pb-2">Emergency Contact</h3>
            <dl class="m-0">
                <dt class="font-medium text-tcsc-gray-600 text-sm">Name</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.emergency_contact_name or '-' }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Relation</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.emergency_contact_relation or '-' }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Phone</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.emergency_contact_phone or '-' }}</dd>
                <dt class="font-medium text-tcsc-gray-600 text-sm mt-3">Email</dt>
                <dd class="m-0 mt-1 text-tcsc-navy">{{ user.emergency_contact_email or '-' }}</dd>
            </dl>
        </div>
    </div>

    <!-- Season History -->
    <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100 mb-6">
        <h2 class="m-0 mb-4 text-tcsc-navy text-lg font-semibold">Season History</h2>
        {% if user_seasons and user_seasons|length > 0 %}
        <div class="overflow-x-auto">
            <table class="min-w-full text-left text-sm">
                <thead>
                    <tr class="border-b border-tcsc-gray-100">
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Season</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Year</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Type</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Status</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Registration Date</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Payment Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for us, season in user_seasons %}
                    <tr class="border-b border-zinc-950/5 hover:bg-zinc-950/[0.025]">
                        <td class="px-4 py-3">{{ season.name }}</td>
                        <td class="px-4 py-3">{{ season.year }}</td>
                        <td class="px-4 py-3">{{ us.registration_type|capitalize if us.registration_type else '-' }}</td>
                        <td class="px-4 py-3">
                            {% if us.status == 'ACTIVE' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-active">Active</span>
                            {% elif us.status == 'PENDING_LOTTERY' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-pending">Pending Lottery</span>
                            {% elif us.status == 'DROPPED' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-canceled">Dropped</span>
                            {% else %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-unknown">{{ us.status }}</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">{{ us.registration_date.strftime('%Y-%m-%d') if us.registration_date else '-' }}</td>
                        <td class="px-4 py-3">{{ us.payment_date.strftime('%Y-%m-%d') if us.payment_date else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-tcsc-gray-600 text-center py-6">No season registrations found.</p>
        {% endif %}
    </div>

    <!-- Trip Registrations -->
    <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100 mb-6">
        <h2 class="m-0 mb-4 text-tcsc-navy text-lg font-semibold">Trip Registrations</h2>
        {% if trip_registrations and trip_registrations|length > 0 %}
        <div class="overflow-x-auto">
            <table class="min-w-full text-left text-sm">
                <thead>
                    <tr class="border-b border-tcsc-gray-100">
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Trip</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Destination</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Dates</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Status</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Amount Paid</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reg in trip_registrations %}
                    <tr class="border-b border-zinc-950/5 hover:bg-zinc-950/[0.025]">
                        {% if reg.trip %}
                        <td class="px-4 py-3"><a href="{{ url_for('admin.edit_trip', trip_id=reg.trip.id) }}" class="text-tcsc-navy hover:underline">{{ reg.trip.name }}</a></td>
                        <td class="px-4 py-3">{{ reg.trip.destination or '-' }}</td>
                        <td class="px-4 py-3">
                            {% if reg.trip.start_date %}
                                {{ reg.trip.start_date.strftime('%b %d') }}{% if reg.trip.end_date %} - {{ reg.trip.end_date.strftime('%b %d, %Y') }}{% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        {% else %}
                        <td class="px-4 py-3">-</td>
                        <td class="px-4 py-3">-</td>
                        <td class="px-4 py-3">-</td>
                        {% endif %}
                        <td class="px-4 py-3">
                            {% if reg.latest_status == 'succeeded' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-success">Paid</span>
                            {% elif reg.latest_status == 'requires_capture' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-pending">Authorized</span>
                            {% elif reg.latest_status == 'canceled' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-canceled">Canceled</span>
                            {% else %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-unknown">{{ reg.latest_status }}</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">{{ reg.total_paid | format_price }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-tcsc-gray-600 text-center py-6">No trip registrations found.</p>
        {% endif %}
    </div>

    <!-- Payment History -->
    <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100 mb-6">
        <h2 class="m-0 mb-4 text-tcsc-navy text-lg font-semibold">Payment History</h2>
        {% if payments and payments|length > 0 %}
        <div class="overflow-x-auto">
            <table class="min-w-full text-left text-sm">
                <thead>
                    <tr class="border-b border-tcsc-gray-100">
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Date</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Type</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Description</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Amount</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Status</th>
                        <th class="px-4 py-2 font-medium text-tcsc-gray-600">Payment ID</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr class="border-b border-zinc-950/5 hover:bg-zinc-950/[0.025]">
                        <td class="px-4 py-3">{{ payment.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td class="px-4 py-3">
                            {% if payment.payment_type == 'season' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-info">Season</span>
                            {% elif payment.payment_type == 'trip' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-active">Trip</span>
                            {% elif payment.payment_type == 'social_event' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-pending">Social</span>
                            {% else %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-unknown">{{ payment.payment_type }}</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            {% if payment.payment_type == 'season' and payment.season %}
                                {{ payment.season.name }}
                            {% elif payment.payment_type == 'trip' and payment.trip %}
                                {{ payment.trip.name }}
                            {% elif payment.payment_type == 'social_event' and payment.social_event %}
                                {{ payment.social_event.name }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">{{ payment.amount | format_price }}</td>
                        <td class="px-4 py-3">
                            {% if payment.status == 'succeeded' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-success">Succeeded</span>
                            {% elif payment.status == 'requires_capture' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-requires_capture">Requires Capture</span>
                            {% elif payment.status in ['requires_payment_method', 'requires_confirmation', 'requires_action'] %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-pending">{{ payment.status | replace('_', ' ') | title }}</span>
                            {% elif payment.status == 'canceled' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-canceled">Canceled</span>
                            {% elif payment.status == 'processing' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-processing">Processing</span>
                            {% elif payment.status == 'refunded' %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-refunded">Refunded</span>
                            {% else %}
                                <span class="inline-flex items-center gap-1.5 rounded-md px-2 py-0.5 text-sm font-medium status-unknown">{{ payment.status }}</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3"><code class="font-mono text-xs text-tcsc-gray-600">{{ payment.payment_intent_id[:20] }}...</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-tcsc-gray-600 text-center py-6">No payments found for this member.</p>
        {% endif %}
    </div>

    {% if user.notes %}
    <!-- Admin Notes -->
    <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100 mb-6">
        <h2 class="m-0 mb-4 text-tcsc-navy text-lg font-semibold">Admin Notes</h2>
        <p class="m-0 text-tcsc-navy">{{ user.notes }}</p>
    </div>
    {% endif %}
</div>
{% endblock %}
