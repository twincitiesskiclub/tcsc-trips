{% extends 'admin/admin_base.html' %}
{% block extra_css %}
<style>
/* Log output color classes */
.log-output .log-info {
    color: #60a5fa;
}

.log-output .log-success {
    color: #34d399;
}

.log-output .log-warning {
    color: #fbbf24;
}

.log-output .log-error {
    color: #f87171;
}

/* Toast animation */
.toast-notification {
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.toast-notification.show {
    opacity: 1;
    transform: translateX(0);
}

/* Loading state for buttons */
.action-btn.loading {
    pointer-events: none;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex flex-wrap justify-between items-center gap-3 mb-5">
        <h1 class="text-2xl font-semibold text-tcsc-navy m-0">Scheduled Tasks</h1>
        <button class="bg-gray-200 text-gray-600 border-none px-5 py-2.5 rounded-tcsc text-sm font-medium cursor-pointer inline-flex items-center gap-2 transition-all hover:bg-gray-300" onclick="loadStatus()">
            <span class="btn-icon">‚Üª</span>
            <span class="btn-text">Refresh</span>
        </button>
    </div>

    <!-- Status Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
        <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-4 text-center min-h-[80px]" id="scheduler-card">
            <div class="text-2xl font-semibold text-tcsc-navy" id="stat-scheduler">-</div>
            <div class="text-sm text-tcsc-gray-600 mt-2">Scheduler</div>
        </div>
        <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-4 text-center min-h-[80px]">
            <div class="text-2xl font-semibold text-tcsc-navy" id="stat-jobs-count">-</div>
            <div class="text-sm text-tcsc-gray-600 mt-2">Active Jobs</div>
        </div>
        <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-4 text-center min-h-[80px]">
            <div class="text-2xl font-semibold text-tcsc-navy" id="stat-current-job">-</div>
            <div class="text-sm text-tcsc-gray-600 mt-2">Current</div>
        </div>
    </div>

    <!-- Manual Triggers Section -->
    <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-5 mb-6">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-base font-semibold text-tcsc-navy m-0">Manual Triggers</h3>
        </div>
        <div class="grid gap-4" id="jobs-list">
            <!-- Job cards rendered by JS -->
            <div class="text-tcsc-gray-600 text-center py-5">
                Loading jobs...
            </div>
        </div>
    </div>

    <!-- Activity Log -->
    <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-5 mb-6">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-base font-semibold text-tcsc-navy m-0">Activity Log</h3>
            <button class="bg-gray-200 text-gray-600 border-none px-4 py-2 rounded-tcsc text-sm font-medium cursor-pointer inline-flex items-center gap-2 transition-all hover:bg-gray-300" onclick="clearLog()">
                <span class="btn-icon">üóë</span>
                <span class="btn-text">Clear</span>
            </button>
        </div>
        <div class="log-output bg-gray-900 text-gray-100 p-4 rounded-tcsc font-mono text-sm leading-relaxed max-h-96 overflow-y-auto whitespace-pre-wrap break-words" id="log-output">Waiting for activity...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Job and channel data (loaded from server)
let jobsData = [];
let channelsData = [];

// Log helper
function log(message, level = 'info') {
    const logEl = document.getElementById('log-output');
    const timestamp = new Date().toLocaleTimeString();
    const levelClass = `log-${level}`;
    logEl.innerHTML += `<span class="${levelClass}">[${timestamp}] ${message}</span>\n`;
    logEl.scrollTop = logEl.scrollHeight;
}

function clearLog() {
    document.getElementById('log-output').innerHTML = '';
}

// Toast notifications
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    let bgClass = 'bg-blue-100 text-blue-800';
    if (type === 'success') bgClass = 'bg-green-100 text-green-800';
    if (type === 'error') bgClass = 'bg-red-100 text-red-800';
    toast.className = `toast-notification fixed top-5 right-5 px-5 py-3 rounded-tcsc font-medium text-sm z-[2000] max-w-[calc(100%-40px)] ${bgClass}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    requestAnimationFrame(() => toast.classList.add('show'));

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Load status and jobs
async function loadStatus() {
    try {
        log('Loading status...');

        // Load status and channels in parallel
        const [statusRes, channelsRes] = await Promise.all([
            fetch('/admin/scheduled-tasks/status'),
            fetch('/admin/scheduled-tasks/channels')
        ]);

        const statusData = await statusRes.json();
        const channelsDataRes = await channelsRes.json();

        channelsData = channelsDataRes.channels;
        jobsData = statusData.jobs;

        // Update scheduler status
        const schedulerCard = document.getElementById('scheduler-card');
        const schedulerStat = document.getElementById('stat-scheduler');
        if (statusData.scheduler.running) {
            schedulerStat.textContent = '‚úì Running';
            schedulerStat.className = 'text-2xl font-semibold text-green-600';
        } else {
            schedulerStat.textContent = '‚úó Stopped';
            schedulerStat.className = 'text-2xl font-semibold text-red-600';
        }

        // Update jobs count
        document.getElementById('stat-jobs-count').textContent =
            statusData.scheduler.jobs?.length || 0;

        // Update current job status
        const currentJob = statusData.current_job;
        if (currentJob.running) {
            document.getElementById('stat-current-job').textContent = currentJob.job_name || 'Running';
        } else {
            document.getElementById('stat-current-job').textContent = 'Idle';
        }

        // Render job cards
        renderJobs();

        log('Status loaded', 'success');

    } catch (error) {
        log(`Failed to load status: ${error.message}`, 'error');
        showToast('Failed to load status', 'error');
    }
}

// Render job cards
function renderJobs() {
    const container = document.getElementById('jobs-list');

    if (!jobsData || jobsData.length === 0) {
        container.innerHTML = '<div class="text-tcsc-gray-600 text-center py-5">No jobs available</div>';
        return;
    }

    // Build channel options
    const channelOptions = channelsData.map(c =>
        `<option value="${c.id}">${c.name}</option>`
    ).join('');

    let html = '';
    for (const job of jobsData) {
        const nextRunText = job.next_run
            ? new Date(job.next_run).toLocaleString()
            : 'Not scheduled';

        html += `
            <div class="bg-gray-50 border border-tcsc-gray-100 rounded-tcsc p-4" id="job-${job.id}">
                <div class="flex flex-col sm:flex-row justify-between items-start gap-2 mb-2">
                    <div class="font-semibold text-sm text-tcsc-navy">${job.name}</div>
                    <div class="text-xs text-tcsc-gray-600 font-mono bg-white px-2 py-0.5 rounded">${job.schedule}</div>
                </div>
                <div class="text-sm text-gray-700 mb-3">${job.description}</div>
                <div class="flex items-center gap-3 text-xs text-tcsc-gray-600 mb-3">
                    <div class="flex items-center gap-1">
                        <span>Default:</span>
                        <strong>${job.default_channel}</strong>
                    </div>
                    <div class="flex items-center gap-1">
                        <span>Next:</span>
                        <span>${nextRunText}</span>
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-3">
                    ${job.supports_channel_override ? `
                        <select class="px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm bg-white min-w-[200px]" id="channel-${job.id}">
                            ${channelOptions}
                        </select>
                    ` : ''}
                    <button class="bg-tcsc-navy text-white border-none px-4 py-2 rounded-tcsc text-sm font-medium cursor-pointer inline-flex items-center gap-1.5 transition-all hover:opacity-90 disabled:opacity-60 disabled:cursor-not-allowed" id="btn-${job.id}" onclick="triggerJob('${job.id}')">
                        <span>‚ñ∂</span>
                        <span>Run Now</span>
                    </button>
                </div>
            </div>
        `;
    }

    container.innerHTML = html;
}

// Trigger a job
async function triggerJob(jobId) {
    const btn = document.getElementById(`btn-${jobId}`);
    const channelSelect = document.getElementById(`channel-${jobId}`);

    // Get channel override
    const channelOverride = channelSelect?.value !== 'default' ? channelSelect.value : null;
    const channelText = channelOverride ? ` ‚Üí #${channelOverride}` : '';

    // Find job name
    const job = jobsData.find(j => j.id === jobId);
    const jobName = job?.name || jobId;

    log(`Triggering ${jobName}${channelText}...`, 'info');

    // Disable button
    btn.disabled = true;
    btn.innerHTML = '<span>‚è≥</span><span>Running...</span>';

    try {
        // Start the job
        const response = await fetch(`/admin/scheduled-tasks/trigger/${jobId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ channel_override: channelOverride || 'default' })
        });

        const data = await response.json();

        if (data.status === 'already_running') {
            log(`Another job is already running: ${data.job_name}`, 'warning');
            showToast('Another job is running', 'warning');
            return;
        }

        if (data.status === 'started') {
            log(`${jobName} started, polling for results...`, 'info');
            await pollForResults(jobId, jobName);
        } else if (data.error) {
            log(`Error: ${data.error}`, 'error');
            showToast(data.error, 'error');
        }

    } catch (error) {
        log(`Failed: ${error.message}`, 'error');
        showToast('Job failed', 'error');
    } finally {
        // Re-enable button
        btn.disabled = false;
        btn.innerHTML = '<span>‚ñ∂</span><span>Run Now</span>';
        loadStatus(); // Refresh status
    }
}

// Poll for results
async function pollForResults(jobId, jobName) {
    const maxAttempts = 120; // 2 minutes max
    let attempts = 0;

    while (attempts < maxAttempts) {
        attempts++;

        try {
            const response = await fetch('/admin/scheduled-tasks/result');
            const data = await response.json();

            if (data.status === 'running') {
                if (attempts % 5 === 0) {
                    log(`Still running... (${attempts}s)`, 'info');
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
                continue;
            }

            if (data.status === 'completed') {
                const channelText = data.channel_override ? ` (‚Üí #${data.channel_override})` : '';
                log(`${jobName} completed${channelText}`, 'success');

                // Log result details if available
                if (data.result) {
                    const r = data.result;
                    if (r.status) {
                        log(`  Status: ${r.status} (${r.mode})`, 'info');
                    }
                }

                showToast(`${jobName} completed`, 'success');
                return;
            }

            if (data.status === 'error') {
                log(`${jobName} failed: ${data.error}`, 'error');
                showToast(`${jobName} failed`, 'error');
                return;
            }

            // Idle or unexpected status
            log(`Job finished (status: ${data.status})`, 'info');
            return;

        } catch (error) {
            log(`Polling error: ${error.message}`, 'error');
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }

    log('Job timed out after 2 minutes', 'error');
    showToast('Job timed out', 'error');
}

// Load status on page load
document.addEventListener('DOMContentLoaded', loadStatus);
</script>
{% endblock %}
