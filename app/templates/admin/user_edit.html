{% extends 'admin/admin_base.html' %}
{% from 'macros.html' import user_season_badge, user_status_badge %}

{% block extra_css %}
<style>
/* Season status dropdown - visual indicator when changed */
.season-status-select.changed {
    border-color: #f59e0b;
    background: #fffbeb;
}
</style>
{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex justify-between items-center flex-wrap gap-4">
        <h1 class="text-2xl font-semibold text-tcsc-navy m-0">Edit: {{ user.full_name }}</h1>
        <div class="flex gap-3">
            <a href="{{ url_for('admin.get_admin_users') }}" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-tcsc text-sm font-medium hover:bg-gray-300 transition-all">Back to List</a>
            <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-tcsc text-sm font-medium hover:bg-gray-300 transition-all">View Details</a>
            <button type="button" class="bg-red-600 text-white px-4 py-2 rounded-tcsc text-sm font-medium hover:bg-red-700 transition-all" onclick="showDeleteModal()">Delete User</button>
        </div>
    </div>
</div>

{% if feedback %}
<div class="bg-tcsc-sky text-tcsc-navy px-4 py-3 rounded-tcsc mb-5">Changes saved successfully!</div>
{% endif %}

<form method="post">
    <input type="hidden" name="form_type" value="full">

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-8">
        <!-- Contact Information -->
        <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
            <h3 class="text-base font-semibold text-tcsc-navy m-0 mb-4 pb-2 border-b border-tcsc-gray-100">Contact Information</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Email</label>
                <input type="email" name="email" value="{{ user.email }}" required
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Phone</label>
                <input type="tel" name="phone" value="{{ user.phone or '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Address</label>
                <input type="text" name="address" value="{{ user.address or '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
            <div>
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Slack UID</label>
                <input type="text" name="slack_uid" value="{{ user.slack_user.slack_uid if user.slack_user else '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
        </div>

        <!-- Profile -->
        <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
            <h3 class="text-base font-semibold text-tcsc-navy m-0 mb-4 pb-2 border-b border-tcsc-gray-100">Profile</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">First Name</label>
                <input type="text" name="first_name" value="{{ user.first_name or '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Last Name</label>
                <input type="text" name="last_name" value="{{ user.last_name or '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Status</label>
                <div class="flex items-center gap-3 py-2">
                    {{ user_status_badge(user.status) }}
                    <span class="text-xs text-tcsc-gray-600 italic">Derived from season registration</span>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Pronouns</label>
                <input type="text" name="pronouns" value="{{ user.pronouns or '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
            <div>
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Date of Birth</label>
                <input type="date" name="date_of_birth" value="{{ user.date_of_birth.strftime('%Y-%m-%d') if user.date_of_birth else '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
        </div>

        <!-- Skiing Info -->
        <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
            <h3 class="text-base font-semibold text-tcsc-navy m-0 mb-4 pb-2 border-b border-tcsc-gray-100">Skiing Info</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Preferred Technique</label>
                <select name="preferred_technique"
                        class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
                    <option value="">--</option>
                    <option value="Classic" {% if user.preferred_technique == 'Classic' %}selected{% endif %}>Classic</option>
                    <option value="Skate" {% if user.preferred_technique == 'Skate' %}selected{% endif %}>Skate</option>
                    <option value="None" {% if user.preferred_technique == 'None' %}selected{% endif %}>None</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Experience (Years)</label>
                <input type="text" name="ski_experience" value="{{ user.ski_experience or '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
            <div>
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">T-Shirt Size</label>
                <select name="tshirt_size"
                        class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
                    <option value="">--</option>
                    <option value="XS" {% if user.tshirt_size == 'XS' %}selected{% endif %}>XS</option>
                    <option value="S" {% if user.tshirt_size == 'S' %}selected{% endif %}>S</option>
                    <option value="M" {% if user.tshirt_size == 'M' %}selected{% endif %}>M</option>
                    <option value="L" {% if user.tshirt_size == 'L' %}selected{% endif %}>L</option>
                    <option value="XL" {% if user.tshirt_size == 'XL' %}selected{% endif %}>XL</option>
                    <option value="XXL" {% if user.tshirt_size == 'XXL' %}selected{% endif %}>XXL</option>
                </select>
            </div>
        </div>

        <!-- Emergency Contact -->
        <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
            <h3 class="text-base font-semibold text-tcsc-navy m-0 mb-4 pb-2 border-b border-tcsc-gray-100">Emergency Contact</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Name</label>
                <input type="text" name="emergency_contact_name" value="{{ user.emergency_contact_name or '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Relation</label>
                <input type="text" name="emergency_contact_relation" value="{{ user.emergency_contact_relation or '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Phone</label>
                <input type="tel" name="emergency_contact_phone" value="{{ user.emergency_contact_phone or '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
            <div>
                <label class="block text-sm font-medium text-tcsc-gray-600 mb-1.5">Email</label>
                <input type="email" name="emergency_contact_email" value="{{ user.emergency_contact_email or '' }}"
                       class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy">
            </div>
        </div>

        <!-- Admin Notes -->
        <div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
            <h3 class="text-base font-semibold text-tcsc-navy m-0 mb-4 pb-2 border-b border-tcsc-gray-100">Admin Notes</h3>
            <div>
                <textarea name="notes" placeholder="Internal notes about this member..."
                          class="w-full px-3 py-2 border border-tcsc-gray-100 rounded-tcsc text-sm focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy resize-y min-h-20">{{ user.notes or '' }}</textarea>
            </div>
        </div>
    </div>

    <!-- Season History -->
    <div class="mt-8 bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
        <h2 class="text-lg font-semibold text-tcsc-navy m-0 mb-4">Season History</h2>
        {% if user_seasons and user_seasons|length > 0 %}
        <table class="min-w-full text-left text-sm">
            <thead>
                <tr class="border-b border-tcsc-gray-100">
                    <th class="px-4 py-2 font-medium text-tcsc-gray-600">Season</th>
                    <th class="px-4 py-2 font-medium text-tcsc-gray-600">Year</th>
                    <th class="px-4 py-2 font-medium text-tcsc-gray-600">Type</th>
                    <th class="px-4 py-2 font-medium text-tcsc-gray-600">Status</th>
                    <th class="px-4 py-2 font-medium text-tcsc-gray-600">Registration Date</th>
                    <th class="px-4 py-2 font-medium text-tcsc-gray-600">Payment Date</th>
                </tr>
            </thead>
            <tbody>
                {% for us, season in user_seasons %}
                <tr class="border-b border-tcsc-gray-100/50 hover:bg-zinc-50">
                    <td class="px-4 py-3">{{ season.name }}</td>
                    <td class="px-4 py-3">{{ season.year }}</td>
                    <td class="px-4 py-3">{{ us.registration_type|capitalize if us.registration_type else '-' }}</td>
                    <td class="px-4 py-3">
                        <select name="user_season_status_{{ us.season_id }}" class="season-status-select px-2.5 py-1.5 text-sm border border-tcsc-gray-100 rounded-tcsc bg-white min-w-40 focus:outline-none focus:ring-2 focus:ring-tcsc-navy/20 focus:border-tcsc-navy" data-original="{{ us.status }}">
                            <option value="PENDING_LOTTERY" {% if us.status == 'PENDING_LOTTERY' %}selected{% endif %}>Pending Lottery</option>
                            <option value="ACTIVE" {% if us.status == 'ACTIVE' %}selected{% endif %}>Active</option>
                            <option value="DROPPED_LOTTERY" {% if us.status == 'DROPPED_LOTTERY' %}selected{% endif %}>Dropped (Lottery)</option>
                            <option value="DROPPED_VOLUNTARY" {% if us.status == 'DROPPED_VOLUNTARY' %}selected{% endif %}>Dropped (Voluntary)</option>
                            <option value="DROPPED_CAUSE" {% if us.status == 'DROPPED_CAUSE' %}selected{% endif %}>Dropped (Cause)</option>
                        </select>
                    </td>
                    <td class="px-4 py-3">{{ us.registration_date.strftime('%Y-%m-%d') if us.registration_date else '-' }}</td>
                    <td class="px-4 py-3">{{ us.payment_date.strftime('%Y-%m-%d') if us.payment_date else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-tcsc-gray-600 text-center py-6">No season registrations found.</p>
        {% endif %}
    </div>

    <div class="flex justify-end gap-3 mt-6 pt-5 border-t border-tcsc-gray-100">
        <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" class="bg-gray-200 text-gray-600 px-6 py-2.5 rounded-tcsc text-sm font-medium hover:bg-gray-300 transition-all">Cancel</a>
        <button type="submit" class="bg-tcsc-navy text-white px-6 py-2.5 rounded-tcsc text-sm font-medium hover:opacity-90 transition-all">Save Changes</button>
    </div>
</form>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black/50 z-[1000] items-center justify-center">
    <div class="bg-white p-6 rounded-tcsc max-w-md w-[90%] shadow-xl">
        <h3 class="text-lg font-semibold text-tcsc-navy m-0 mb-3">Delete User</h3>
        <p class="text-tcsc-gray-600 m-0 mb-5">Are you sure you want to delete <strong>{{ user.full_name }}</strong>? This action cannot be undone.</p>
        <div class="flex gap-3 justify-end">
            <button type="button" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-tcsc text-sm font-medium hover:bg-gray-300 transition-all" onclick="hideDeleteModal()">Cancel</button>
            <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}" class="inline">
                <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-tcsc text-sm font-medium hover:bg-red-700 transition-all">Delete</button>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Season status dropdown change handling
    const statusSelects = document.querySelectorAll('.season-status-select');

    statusSelects.forEach(select => {
        select.addEventListener('change', function(e) {
            const newValue = e.target.value;
            const originalValue = e.target.dataset.original;

            // Highlight changed dropdowns
            if (newValue !== originalValue) {
                e.target.classList.add('changed');
            } else {
                e.target.classList.remove('changed');
            }

            // Confirmation for DROPPED statuses
            if (newValue.startsWith('DROPPED_') && originalValue !== newValue) {
                const statusLabels = {
                    'DROPPED_LOTTERY': 'Dropped (Lottery)',
                    'DROPPED_VOLUNTARY': 'Dropped (Voluntary)',
                    'DROPPED_CAUSE': 'Dropped (Cause)'
                };
                const confirmed = confirm(
                    `Are you sure you want to change this season status to "${statusLabels[newValue]}"?\n\n` +
                    `This will affect the user's global status when saved.`
                );
                if (!confirmed) {
                    e.target.value = originalValue;
                    e.target.classList.remove('changed');
                }
            }
        });
    });
});

// Delete modal functions
function showDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function hideDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideDeleteModal();
    }
});

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideDeleteModal();
    }
});
</script>
{% endblock %}
