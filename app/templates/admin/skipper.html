{% extends 'admin/admin_base.html' %}
{% block extra_css %}
<style>
/* Status badges */
.status-pending {
    background: rgb(245 158 11 / 0.2);
    color: rgb(180 83 9);
}

.status-approved {
    background: rgb(16 185 129 / 0.15);
    color: rgb(4 120 87);
}

.status-rejected {
    background: rgb(113 113 122 / 0.15);
    color: rgb(63 63 70);
}

.status-expired {
    background: rgb(239 68 68 / 0.15);
    color: rgb(153 27 27);
}
</style>
{% endblock %}

{% block content %}
<div class="bg-white rounded-tcsc p-5 max-w-6xl mx-auto">
    <h1 class="m-0 mb-5 text-xl text-tcsc-navy font-semibold">Skipper Dashboard</h1>

    <!-- Pending Proposals Section -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-3 pb-2 border-b-2 border-tcsc-navy">
            <h2 class="m-0 text-base text-tcsc-navy font-semibold">Pending Cancellation Proposals</h2>
        </div>
        <div id="pending-proposals">
            <div class="py-10 text-center text-tcsc-gray-600 italic bg-gray-50 rounded-tcsc">No pending proposals</div>
        </div>
    </div>

    <!-- Recent Decisions Section -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-3 pb-2 border-b-2 border-tcsc-navy">
            <h2 class="m-0 text-base text-tcsc-navy font-semibold">Recent Decisions</h2>
        </div>
        <div id="decisions-table" class="tabulator-data"></div>
    </div>

    <!-- Configuration Section -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-3 pb-2 border-b-2 border-tcsc-navy">
            <h2 class="m-0 text-base text-tcsc-navy font-semibold">Skipper Configuration</h2>
            <button class="toolbar-btn toolbar-btn-secondary" onclick="refreshConfig()">Refresh</button>
        </div>
        <div id="config-display">
            <p class="text-tcsc-gray-600 italic">Loading configuration...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let proposalsData = [];
let decisionsTable;

// Load proposals on page load
document.addEventListener('DOMContentLoaded', async () => {
    await loadProposals();
    await loadConfig();
    initDecisionsTable();
});

async function loadProposals() {
    try {
        const response = await fetch('/admin/skipper/data');
        const data = await response.json();
        proposalsData = data.proposals;

        renderPendingProposals();
        renderDecisionsTable();
    } catch (error) {
        console.error('Error loading proposals:', error);
        showToast('Failed to load proposals', 'error');
    }
}

function renderPendingProposals() {
    const container = document.getElementById('pending-proposals');
    const pending = proposalsData.filter(p => p.status === 'pending');

    if (pending.length === 0) {
        container.innerHTML = '<div class="py-10 text-center text-tcsc-gray-600 italic bg-gray-50 rounded-tcsc">No pending proposals</div>';
        return;
    }

    let html = '';
    for (const proposal of pending) {
        const practiceDate = new Date(proposal.practice_date).toLocaleString();
        const proposedDate = new Date(proposal.proposed_at).toLocaleString();

        html += `
            <div class="bg-white border border-gray-300 rounded-lg p-4 mb-3">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="font-semibold text-sm text-tcsc-navy">${proposal.practice_location} - ${practiceDate}</div>
                        <div class="text-xs text-tcsc-gray-600">Proposed: ${proposedDate}</div>
                    </div>
                    <span class="inline-block px-2 py-0.5 rounded-full text-xs font-semibold status-${proposal.status}">${proposal.status}</span>
                </div>
                <div class="p-3 bg-amber-50 border-l-[3px] border-amber-500 rounded mb-3">
                    <div class="font-semibold text-[11px] uppercase text-amber-800 mb-1">${proposal.reason_type.replace('_', ' ')}</div>
                    <div class="text-sm text-amber-900">${proposal.reason_summary}</div>
                </div>
                <div class="tbl-actions justify-end">
                    <button class="tbl-btn tbl-btn-secondary" onclick="rejectProposal(${proposal.id})">Reject</button>
                    <button class="tbl-btn tbl-btn-primary" onclick="approveProposal(${proposal.id})">Approve Cancellation</button>
                </div>
            </div>`;
    }

    container.innerHTML = html;
}

function initDecisionsTable() {
    decisionsTable = new Tabulator("#decisions-table", {
        data: proposalsData.filter(p => p.status !== 'pending'),
        layout: "fitDataStretch",
        height: "300px",
        placeholder: "No decisions recorded",
        columns: [
            {title: "Practice", field: "practice_location", minWidth: 120},
            {title: "Date", field: "practice_date", minWidth: 150,
             formatter: (cell) => new Date(cell.getValue()).toLocaleString()
            },
            {title: "Status", field: "status", minWidth: 100,
             formatter: (cell) => {
                 const val = cell.getValue();
                 return `<span class="inline-block px-2 py-0.5 rounded-full text-xs font-semibold status-${val}">${val}</span>`;
             }
            },
            {title: "Reason", field: "reason_type", minWidth: 120},
            {title: "Decided By", field: "decided_by", minWidth: 120},
            {title: "Decided At", field: "decided_at", minWidth: 150,
             formatter: (cell) => {
                 const val = cell.getValue();
                 return val ? new Date(val).toLocaleString() : 'â€”';
             }
            },
        ],
        initialSort: [{column: "decided_at", dir: "desc"}],
    });
}

function renderDecisionsTable() {
    if (decisionsTable) {
        decisionsTable.setData(proposalsData.filter(p => p.status !== 'pending'));
    }
}

async function approveProposal(proposalId) {
    const notes = prompt('Optional decision notes:');
    if (notes === null) return; // Cancelled

    try {
        const response = await fetch(`/admin/skipper/approve/${proposalId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notes})
        });

        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
            await loadProposals();
        } else {
            showToast(result.error || 'Failed to approve', 'error');
        }
    } catch (error) {
        console.error('Error approving proposal:', error);
        showToast('Failed to approve proposal', 'error');
    }
}

async function rejectProposal(proposalId) {
    const notes = prompt('Optional decision notes:');
    if (notes === null) return; // Cancelled

    try {
        const response = await fetch(`/admin/skipper/reject/${proposalId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notes})
        });

        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
            await loadProposals();
        } else {
            showToast(result.error || 'Failed to reject', 'error');
        }
    } catch (error) {
        console.error('Error rejecting proposal:', error);
        showToast('Failed to reject proposal', 'error');
    }
}

async function loadConfig() {
    try {
        const response = await fetch('/admin/skipper/config');
        const result = await response.json();

        if (result.success) {
            renderConfig(result.config);
        }
    } catch (error) {
        console.error('Error loading config:', error);
    }
}

function renderConfig(config) {
    const container = document.getElementById('config-display');
    const thresholds = config.thresholds || {};
    const weatherThresholds = thresholds.weather || {};
    const leadThresholds = thresholds.lead || {};

    let html = '<h3 class="m-0 mb-3 text-sm text-tcsc-gray-600 font-medium">Weather Thresholds</h3>';
    html += '<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">';
    for (const [key, value] of Object.entries(weatherThresholds)) {
        html += `
            <div class="p-3 bg-gray-50 border border-gray-200 rounded-tcsc">
                <div class="text-[11px] font-semibold uppercase text-tcsc-gray-600 mb-1">${key.replace(/_/g, ' ')}</div>
                <div class="text-sm font-semibold text-tcsc-navy">${value}</div>
            </div>`;
    }
    html += '</div>';

    html += '<h3 class="mt-5 mb-3 text-sm text-tcsc-gray-600 font-medium">Lead Requirements</h3>';
    html += '<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">';
    for (const [key, value] of Object.entries(leadThresholds)) {
        const displayValue = typeof value === 'boolean' ? (value ? 'Yes' : 'No') : value;
        html += `
            <div class="p-3 bg-gray-50 border border-gray-200 rounded-tcsc">
                <div class="text-[11px] font-semibold uppercase text-tcsc-gray-600 mb-1">${key.replace(/_/g, ' ')}</div>
                <div class="text-sm font-semibold text-tcsc-navy">${displayValue}</div>
            </div>`;
    }
    html += '</div>';

    container.innerHTML = html;
}

async function refreshConfig() {
    await loadConfig();
    showToast('Configuration refreshed', 'success');
}
</script>
{% endblock %}
