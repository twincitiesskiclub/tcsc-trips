{% extends 'admin/admin_base.html' %}
{% block title %}Practices Configuration{% endblock %}


{% block extra_css %}
<style>
/* Toggle slider for defaults editor */
.defaults-toggle-slider {
    position: relative;
    width: 40px;
    height: 22px;
    background: #d1d5db;
    border-radius: 11px;
    transition: background 0.2s;
    flex-shrink: 0;
}
.defaults-toggle-slider::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 18px;
    height: 18px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.defaults-toggle-input:checked + .defaults-toggle-slider {
    background: #1c2c44;
}
.defaults-toggle-input:checked + .defaults-toggle-slider::after {
    transform: translateX(18px);
}
</style>
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold text-tcsc-navy">Practices Configuration</h1>
    <div class="flex gap-2">
        <a href="{{ url_for('admin_practices.practices_list') }}" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-tcsc text-sm font-medium hover:bg-gray-300 transition-all">Back to Practices</a>
    </div>
</div>

<div class="bg-white p-5 rounded-tcsc border border-tcsc-gray-100">
    <!-- Tab Navigation -->
    <div class="flex gap-0 border-b-2 border-gray-200 mb-5">
        <button class="config-tab active py-3 px-6 text-sm font-medium text-tcsc-navy bg-transparent border-none border-b-2 border-tcsc-navy -mb-0.5 cursor-pointer transition-all hover:text-tcsc-navy" data-tab="locations">Locations</button>
        <button class="config-tab py-3 px-6 text-sm font-medium text-gray-500 bg-transparent border-none border-b-2 border-transparent -mb-0.5 cursor-pointer transition-all hover:text-tcsc-navy" data-tab="activities">Activities</button>
        <button class="config-tab py-3 px-6 text-sm font-medium text-gray-500 bg-transparent border-none border-b-2 border-transparent -mb-0.5 cursor-pointer transition-all hover:text-tcsc-navy" data-tab="types">Types</button>
        <button class="config-tab py-3 px-6 text-sm font-medium text-gray-500 bg-transparent border-none border-b-2 border-transparent -mb-0.5 cursor-pointer transition-all hover:text-tcsc-navy" data-tab="social-locations">Social Locations</button>
        <button class="config-tab py-3 px-6 text-sm font-medium text-gray-500 bg-transparent border-none border-b-2 border-transparent -mb-0.5 cursor-pointer transition-all hover:text-tcsc-navy" data-tab="settings">Settings</button>
        <button class="config-tab py-3 px-6 text-sm font-medium text-gray-500 bg-transparent border-none border-b-2 border-transparent -mb-0.5 cursor-pointer transition-all hover:text-tcsc-navy" data-tab="status-reference">Status Reference</button>
    </div>

    <!-- Tab Content: Locations -->
    <div id="locations-tab" class="tab-content">
        <div class="toolbar">
            <button class="toolbar-btn toolbar-btn-primary" onclick="addNewLocation()">Add Location</button>
            <div class="toolbar-spacer"></div>
            <span class="toolbar-count">Total: <strong id="location-count">0</strong> locations</span>
        </div>
        <div id="locations-table" class="tabulator-config"></div>
    </div>

    <!-- Tab Content: Activities -->
    <div id="activities-tab" class="tab-content hidden">
        <div class="toolbar">
            <button class="toolbar-btn toolbar-btn-primary" onclick="addNewActivity()">Add Activity</button>
            <div class="toolbar-spacer"></div>
            <span class="toolbar-count">Total: <strong id="activity-count">0</strong> activities</span>
        </div>
        <div id="activities-table" class="tabulator-config"></div>
    </div>

    <!-- Tab Content: Types -->
    <div id="types-tab" class="tab-content hidden">
        <div class="toolbar">
            <button class="toolbar-btn toolbar-btn-primary" onclick="addNewType()">Add Type</button>
            <div class="toolbar-spacer"></div>
            <span class="toolbar-count">Total: <strong id="type-count">0</strong> types</span>
        </div>
        <div id="types-table" class="tabulator-config"></div>
    </div>

    <!-- Tab Content: Social Locations -->
    <div id="social-locations-tab" class="tab-content hidden">
        <div class="toolbar">
            <button class="toolbar-btn toolbar-btn-primary" onclick="addNewSocialLocation()">Add Social Location</button>
            <div class="toolbar-spacer"></div>
            <span class="toolbar-count">Total: <strong id="social-location-count">0</strong> social locations</span>
        </div>
        <div id="social-locations-table" class="tabulator-config"></div>
    </div>

    <!-- Tab Content: Settings -->
    <div id="settings-tab" class="tab-content hidden">
        <div class="max-w-[1100px]">
            <h3 class="font-semibold text-base text-tcsc-navy mb-2">Practice Days</h3>
            <p class="text-sm text-gray-500 mb-5 leading-relaxed">Configure which days practices are expected and set default values that auto-fill the Slack create modal.</p>

            <div id="practice-days-editor">
                <div class="flex flex-col gap-4 mb-4" id="practice-days-list"></div>
                <button class="toolbar-btn toolbar-btn-secondary" onclick="addPracticeDay()">+ Add Day</button>
            </div>

            <div class="mt-6 pt-5 border-t border-tcsc-gray-100">
                <button class="toolbar-btn toolbar-btn-primary" onclick="savePracticeDays()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Tab Content: Status Reference (Read-Only) -->
    <div id="status-reference-tab" class="tab-content hidden">
        <div class="grid grid-cols-[repeat(auto-fit,minmax(280px,1fr))] gap-5">
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-sm text-gray-700 mb-3 pb-2 border-b border-gray-200">Practice Status</h3>
                <div id="practice-status-list"></div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-sm text-gray-700 mb-3 pb-2 border-b border-gray-200">Lead Role</h3>
                <div id="lead-role-list"></div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-sm text-gray-700 mb-3 pb-2 border-b border-gray-200">RSVP Status</h3>
                <div id="rsvp-status-list"></div>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-semibold text-sm text-gray-700 mb-3 pb-2 border-b border-gray-200">Cancellation Status</h3>
                <div id="cancellation-status-list"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// State
let locationsTable, activitiesTable, typesTable, socialLocationsTable;
let locationsData = [], activitiesData = [], typesData = [], socialLocationsData = [];
let coachesData = [];
let statusData = {};
let practiceDays = [];

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', async () => {
    // Load all data in parallel
    await Promise.all([
        loadLocations(),
        loadActivities(),
        loadTypes(),
        loadSocialLocations(),
        loadStatuses(),
        loadSettings()
    ]);

    initLocationsTable();
    initActivitiesTable();
    initTypesTable();
    initSocialLocationsTable();
    renderStatusReference();
    renderPracticeDays();
    attachTabListeners();
});

// ============================================================================
// Tab Navigation
// ============================================================================
function attachTabListeners() {
    document.querySelectorAll('.config-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active from all tabs and content
            document.querySelectorAll('.config-tab').forEach(t => {
                t.classList.remove('active');
                t.classList.remove('text-tcsc-navy', 'border-tcsc-navy');
                t.classList.add('text-gray-500', 'border-transparent');
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));

            // Activate clicked tab
            tab.classList.add('active');
            tab.classList.remove('text-gray-500', 'border-transparent');
            tab.classList.add('text-tcsc-navy', 'border-tcsc-navy');
            document.getElementById(tab.dataset.tab + '-tab').classList.remove('hidden');
        });
    });
}

// ============================================================================
// Data Loading
// ============================================================================
async function loadLocations() {
    const response = await fetch('/admin/practices/locations/data');
    const data = await response.json();
    locationsData = data.locations;
    document.getElementById('location-count').textContent = locationsData.length;
}

async function loadActivities() {
    const response = await fetch('/admin/practices/activities/data');
    const data = await response.json();
    activitiesData = data.activities;
    document.getElementById('activity-count').textContent = activitiesData.length;
}

async function loadTypes() {
    const response = await fetch('/admin/practices/types/data');
    const data = await response.json();
    typesData = data.types;
    document.getElementById('type-count').textContent = typesData.length;
}

async function loadSocialLocations() {
    const response = await fetch('/admin/practices/social-locations/data');
    const data = await response.json();
    socialLocationsData = data.social_locations;
    document.getElementById('social-location-count').textContent = socialLocationsData.length;
}

async function loadStatuses() {
    const response = await fetch('/admin/practices/statuses/data');
    statusData = await response.json();
}

// ============================================================================
// Locations Tab
// ============================================================================
function initLocationsTable() {
    locationsTable = new Tabulator("#locations-table", {
        data: locationsData,
        layout: "fitColumns",
        height: "calc(100vh - 380px)",
        columns: [
            {
                title: "Name",
                field: "name",
                minWidth: 140,
                editor: "input",
                validator: "required",
                cellEdited: (cell) => saveLocation(cell.getRow().getData())
            },
            {
                title: "Spot",
                field: "spot",
                minWidth: 120,
                editor: "input",
                cellEdited: (cell) => saveLocation(cell.getRow().getData())
            },
            {
                title: "Address",
                field: "address",
                minWidth: 180,
                editor: "input",
                cellEdited: (cell) => saveLocation(cell.getRow().getData())
            },
            {
                title: "Lat",
                field: "latitude",
                width: 90,
                editor: "number",
                editorParams: { step: 0.0001 },
                cellEdited: (cell) => saveLocation(cell.getRow().getData())
            },
            {
                title: "Lng",
                field: "longitude",
                width: 90,
                editor: "number",
                editorParams: { step: 0.0001 },
                cellEdited: (cell) => saveLocation(cell.getRow().getData())
            },
            {
                title: "Parking Notes",
                field: "parking_notes",
                minWidth: 150,
                editor: "input",
                cellEdited: (cell) => saveLocation(cell.getRow().getData())
            },
            {
                title: "Practices",
                field: "practice_count",
                width: 90,
                hozAlign: "center",
                formatter: (cell) => formatCount(cell.getValue())
            },
            {
                title: "Actions",
                width: 100,
                hozAlign: "center",
                headerSort: false,
                formatter: (cell) => formatDeleteButton(cell, 'Location', 'practice_count')
            }
        ]
    });
}

async function saveLocation(data) {
    const url = data.id ? `/admin/practices/locations/${data.id}/edit` : '/admin/practices/locations/create';

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: data.name,
                spot: data.spot,
                address: data.address,
                google_maps_url: data.google_maps_url,
                latitude: data.latitude,
                longitude: data.longitude,
                parking_notes: data.parking_notes
            })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            if (result.location) {
                const idx = locationsData.findIndex(l => l.id === data.id || (!l.id && l.name === data.name));
                if (idx >= 0) {
                    locationsData[idx] = result.location;
                    locationsTable.updateData([result.location]);
                }
            }
            showToast('Location saved successfully', 'success');
        } else {
            showToast(result.error || 'Failed to save location', 'error');
            refreshLocations();
        }
    } catch (err) {
        showToast('Error saving location: ' + err.message, 'error');
        refreshLocations();
    }
}

async function deleteLocation(id, name) {
    if (!confirm(`Delete location "${name}"?\n\nThis cannot be undone.`)) return;

    try {
        const response = await fetch(`/admin/practices/locations/${id}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (response.ok && result.success) {
            showToast(result.message, 'success');
            refreshLocations();
        } else {
            showToast(result.error || 'Failed to delete location', 'error');
        }
    } catch (err) {
        showToast('Error deleting location: ' + err.message, 'error');
    }
}

function addNewLocation() {
    const newLoc = {
        id: null,
        name: 'New Location',
        spot: '',
        address: '',
        latitude: null,
        longitude: null,
        parking_notes: '',
        practice_count: 0
    };
    locationsTable.addRow(newLoc, true);
    setTimeout(() => {
        const rows = locationsTable.getRows();
        if (rows.length > 0) rows[0].getCell('name').edit();
    }, 100);
}

async function refreshLocations() {
    await loadLocations();
    locationsTable.setData(locationsData);
}

// ============================================================================
// Activities Tab
// ============================================================================
function initActivitiesTable() {
    activitiesTable = new Tabulator("#activities-table", {
        data: activitiesData,
        layout: "fitColumns",
        height: "calc(100vh - 380px)",
        columns: [
            {
                title: "Name",
                field: "name",
                minWidth: 200,
                editor: "input",
                validator: "required",
                cellEdited: (cell) => saveActivity(cell.getRow().getData())
            },
            {
                title: "Gear Required (comma-separated)",
                field: "gear_required",
                minWidth: 300,
                editor: "input",
                formatter: (cell) => formatJsonArray(cell.getValue()),
                cellEdited: (cell) => {
                    const data = cell.getRow().getData();
                    // Convert string to array
                    const rawValue = cell.getValue();
                    if (typeof rawValue === 'string') {
                        data.gear_required = rawValue.split(',').map(s => s.trim()).filter(s => s);
                    }
                    saveActivity(data);
                }
            },
            {
                title: "Practices",
                field: "practice_count",
                width: 90,
                hozAlign: "center",
                formatter: (cell) => formatCount(cell.getValue())
            },
            {
                title: "Actions",
                width: 100,
                hozAlign: "center",
                headerSort: false,
                formatter: (cell) => formatDeleteButton(cell, 'Activity', 'practice_count')
            }
        ]
    });
}

async function saveActivity(data) {
    const url = data.id ? `/admin/practices/activities/${data.id}/edit` : '/admin/practices/activities/create';

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: data.name,
                gear_required: data.gear_required
            })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            if (result.activity) {
                const idx = activitiesData.findIndex(a => a.id === data.id || (!a.id && a.name === data.name));
                if (idx >= 0) {
                    activitiesData[idx] = result.activity;
                    activitiesTable.updateData([result.activity]);
                }
            }
            showToast('Activity saved successfully', 'success');
        } else {
            showToast(result.error || 'Failed to save activity', 'error');
            refreshActivities();
        }
    } catch (err) {
        showToast('Error saving activity: ' + err.message, 'error');
        refreshActivities();
    }
}

async function deleteActivity(id, name) {
    if (!confirm(`Delete activity "${name}"?\n\nThis cannot be undone.`)) return;

    try {
        const response = await fetch(`/admin/practices/activities/${id}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (response.ok && result.success) {
            showToast(result.message, 'success');
            refreshActivities();
        } else {
            showToast(result.error || 'Failed to delete activity', 'error');
        }
    } catch (err) {
        showToast('Error deleting activity: ' + err.message, 'error');
    }
}

function addNewActivity() {
    const newActivity = {
        id: null,
        name: 'New Activity',
        gear_required: [],
        practice_count: 0
    };
    activitiesTable.addRow(newActivity, true);
    setTimeout(() => {
        const rows = activitiesTable.getRows();
        if (rows.length > 0) rows[0].getCell('name').edit();
    }, 100);
}

async function refreshActivities() {
    await loadActivities();
    activitiesTable.setData(activitiesData);
}

// ============================================================================
// Types Tab
// ============================================================================
function initTypesTable() {
    typesTable = new Tabulator("#types-table", {
        data: typesData,
        layout: "fitColumns",
        height: "calc(100vh - 380px)",
        columns: [
            {
                title: "Name",
                field: "name",
                minWidth: 200,
                editor: "input",
                validator: "required",
                cellEdited: (cell) => saveType(cell.getRow().getData())
            },
            {
                title: "Fitness Goals (comma-separated)",
                field: "fitness_goals",
                minWidth: 300,
                editor: "input",
                formatter: (cell) => formatJsonArray(cell.getValue()),
                cellEdited: (cell) => {
                    const data = cell.getRow().getData();
                    // Convert string to array
                    const rawValue = cell.getValue();
                    if (typeof rawValue === 'string') {
                        data.fitness_goals = rawValue.split(',').map(s => s.trim()).filter(s => s);
                    }
                    saveType(data);
                }
            },
            {
                title: "Has Intervals",
                field: "has_intervals",
                width: 110,
                hozAlign: "center",
                editor: "tickCross",
                formatter: "tickCross",
                cellEdited: (cell) => saveType(cell.getRow().getData())
            },
            {
                title: "Practices",
                field: "practice_count",
                width: 90,
                hozAlign: "center",
                formatter: (cell) => formatCount(cell.getValue())
            },
            {
                title: "Actions",
                width: 100,
                hozAlign: "center",
                headerSort: false,
                formatter: (cell) => formatDeleteButton(cell, 'Type', 'practice_count')
            }
        ]
    });
}

async function saveType(data) {
    const url = data.id ? `/admin/practices/types/${data.id}/edit` : '/admin/practices/types/create';

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: data.name,
                fitness_goals: data.fitness_goals,
                has_intervals: data.has_intervals
            })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            if (result.type) {
                const idx = typesData.findIndex(t => t.id === data.id || (!t.id && t.name === data.name));
                if (idx >= 0) {
                    typesData[idx] = result.type;
                    typesTable.updateData([result.type]);
                }
            }
            showToast('Type saved successfully', 'success');
        } else {
            showToast(result.error || 'Failed to save type', 'error');
            refreshTypes();
        }
    } catch (err) {
        showToast('Error saving type: ' + err.message, 'error');
        refreshTypes();
    }
}

async function deleteType(id, name) {
    if (!confirm(`Delete type "${name}"?\n\nThis cannot be undone.`)) return;

    try {
        const response = await fetch(`/admin/practices/types/${id}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (response.ok && result.success) {
            showToast(result.message, 'success');
            refreshTypes();
        } else {
            showToast(result.error || 'Failed to delete type', 'error');
        }
    } catch (err) {
        showToast('Error deleting type: ' + err.message, 'error');
    }
}

function addNewType() {
    const newType = {
        id: null,
        name: 'New Type',
        fitness_goals: [],
        has_intervals: false,
        practice_count: 0
    };
    typesTable.addRow(newType, true);
    setTimeout(() => {
        const rows = typesTable.getRows();
        if (rows.length > 0) rows[0].getCell('name').edit();
    }, 100);
}

async function refreshTypes() {
    await loadTypes();
    typesTable.setData(typesData);
}

// ============================================================================
// Social Locations Tab
// ============================================================================
function initSocialLocationsTable() {
    socialLocationsTable = new Tabulator("#social-locations-table", {
        data: socialLocationsData,
        layout: "fitColumns",
        height: "calc(100vh - 380px)",
        columns: [
            {
                title: "Name",
                field: "name",
                minWidth: 200,
                editor: "input",
                validator: "required",
                cellEdited: (cell) => saveSocialLocation(cell.getRow().getData())
            },
            {
                title: "Address",
                field: "address",
                minWidth: 250,
                editor: "input",
                cellEdited: (cell) => saveSocialLocation(cell.getRow().getData())
            },
            {
                title: "Google Maps URL",
                field: "google_maps_url",
                minWidth: 200,
                editor: "input",
                formatter: (cell) => {
                    const url = cell.getValue();
                    if (!url) return '<span class="text-gray-500">—</span>';
                    return `<a href="${url}" target="_blank" class="text-tcsc-navy hover:underline">View Map</a>`;
                },
                cellEdited: (cell) => saveSocialLocation(cell.getRow().getData())
            },
            {
                title: "Linked Practices",
                field: "practice_count",
                width: 130,
                hozAlign: "center",
                formatter: (cell) => formatCount(cell.getValue())
            },
            {
                title: "Actions",
                width: 100,
                hozAlign: "center",
                headerSort: false,
                formatter: (cell) => formatDeleteButton(cell, 'SocialLocation', 'practice_count')
            }
        ]
    });
}

async function saveSocialLocation(data) {
    const url = data.id ? `/admin/practices/social-locations/${data.id}/edit` : '/admin/practices/social-locations/create';

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: data.name,
                address: data.address,
                google_maps_url: data.google_maps_url
            })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            if (result.social_location) {
                const idx = socialLocationsData.findIndex(s => s.id === data.id || (!s.id && s.name === data.name));
                if (idx >= 0) {
                    socialLocationsData[idx] = result.social_location;
                    socialLocationsTable.updateData([result.social_location]);
                }
            }
            showToast('Social location saved successfully', 'success');
        } else {
            showToast(result.error || 'Failed to save social location', 'error');
            refreshSocialLocations();
        }
    } catch (err) {
        showToast('Error saving social location: ' + err.message, 'error');
        refreshSocialLocations();
    }
}

async function deleteSocialLocation(id, name) {
    if (!confirm(`Delete social location "${name}"?\n\nThis cannot be undone.`)) return;

    try {
        const response = await fetch(`/admin/practices/social-locations/${id}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (response.ok && result.success) {
            showToast(result.message, 'success');
            refreshSocialLocations();
        } else {
            showToast(result.error || 'Failed to delete social location', 'error');
        }
    } catch (err) {
        showToast('Error deleting social location: ' + err.message, 'error');
    }
}

function addNewSocialLocation() {
    const newLoc = {
        id: null,
        name: 'New Social Location',
        address: '',
        google_maps_url: '',
        practice_count: 0
    };
    socialLocationsTable.addRow(newLoc, true);
    setTimeout(() => {
        const rows = socialLocationsTable.getRows();
        if (rows.length > 0) rows[0].getCell('name').edit();
    }, 100);
}

async function refreshSocialLocations() {
    await loadSocialLocations();
    socialLocationsTable.setData(socialLocationsData);
}

// ============================================================================
// Status Reference Tab (Read-Only)
// ============================================================================
function renderStatusReference() {
    renderStatusList('practice_status', 'practice-status-list');
    renderStatusList('lead_role', 'lead-role-list');
    renderStatusList('rsvp_status', 'rsvp-status-list');
    renderStatusList('cancellation_status', 'cancellation-status-list');
}

function renderStatusList(key, elementId) {
    const container = document.getElementById(elementId);
    const items = statusData[key] || [];

    if (items.length === 0) {
        container.innerHTML = '<div class="flex items-center gap-2.5 py-2"><span class="text-sm text-gray-500">No statuses defined</span></div>';
        return;
    }

    container.innerHTML = items.map(s =>
        `<div class="flex items-center gap-2.5 py-2 border-b border-gray-200 last:border-b-0">
            <code class="bg-gray-200 py-0.5 px-2 rounded text-xs font-medium font-mono text-gray-700">${s.value}</code>
            <span class="text-sm text-gray-500">${s.name}</span>
        </div>`
    ).join('');
}

// ============================================================================
// Settings Tab
// ============================================================================
async function loadSettings() {
    const [settingsResp, peopleResp] = await Promise.all([
        fetch('/admin/practices/settings/data'),
        fetch('/admin/practices/people/data')
    ]);
    const settingsData = await settingsResp.json();
    const peopleData = await peopleResp.json();
    practiceDays = settingsData.practice_days || [];
    coachesData = peopleData.coaches || [];
}

function renderPracticeDays() {
    const container = document.getElementById('practice-days-list');
    if (!container) return;

    if (practiceDays.length === 0) {
        container.innerHTML = '<p class="text-gray-500 italic text-sm">No practice days configured. Click "+ Add Day" to add one.</p>';
        return;
    }

    container.innerHTML = practiceDays.map((day, index) => {
        const dayLabel = (day.day || 'monday').charAt(0).toUpperCase() + (day.day || 'monday').slice(1);
        const timeLabel = day.time || '18:00';
        const hasDefaults = day.defaults && Object.keys(day.defaults).length > 0;
        const isExpanded = day._expanded;

        return `
        <div class="bg-white rounded-tcsc border border-tcsc-gray-100 overflow-hidden" data-index="${index}">
            <!-- Day header row -->
            <div class="flex items-center gap-3 px-4 py-3 bg-gray-50/50">
                <select onchange="updatePracticeDay(${index}, 'day', this.value)"
                    class="py-2 px-3 border border-tcsc-gray-100 rounded-tcsc text-sm bg-white min-w-[140px] focus:outline-none focus:border-tcsc-navy focus:ring-2 focus:ring-tcsc-navy/10">
                    ${['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].map(d =>
                        `<option value="${d}" ${day.day?.toLowerCase() === d ? 'selected' : ''}>${d.charAt(0).toUpperCase() + d.slice(1)}</option>`
                    ).join('')}
                </select>
                <input type="time" value="${timeLabel}" onchange="updatePracticeDay(${index}, 'time', this.value)"
                    class="py-2 px-3 border border-tcsc-gray-100 rounded-tcsc text-sm bg-white w-[120px] focus:outline-none focus:border-tcsc-navy focus:ring-2 focus:ring-tcsc-navy/10">
                <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer select-none">
                    <input type="checkbox" ${day.active !== false ? 'checked' : ''} onchange="updatePracticeDay(${index}, 'active', this.checked)"
                        class="w-[18px] h-[18px] cursor-pointer rounded border-tcsc-gray-100 text-tcsc-navy focus:ring-tcsc-navy/20">
                    Active
                </label>
                <div class="ml-auto flex items-center gap-2">
                    ${hasDefaults ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-tcsc-navy/5 text-tcsc-navy">Defaults set</span>' : ''}
                    <button type="button" onclick="removePracticeDay(${index})"
                        class="tbl-btn tbl-btn-danger">Remove</button>
                </div>
            </div>

            <!-- Defaults toggle -->
            <button type="button" onclick="toggleDefaults(${index})"
                class="w-full flex items-center gap-2 px-4 py-2.5 text-left text-sm font-medium text-tcsc-navy bg-transparent border-none border-t border-tcsc-gray-100 cursor-pointer hover:bg-gray-50 transition-colors"
                style="border-top: 1px solid rgba(28,44,68,0.08);">
                <svg id="defaults-chevron-${index}" class="w-4 h-4 text-gray-400 transition-transform ${isExpanded ? 'rotate-90' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span>Workout Defaults</span>
                <span class="font-normal text-xs text-gray-400 ml-1">${renderDefaultsSummary(day.defaults)}</span>
            </button>

            <!-- Defaults editor panel -->
            <div id="defaults-editor-${index}" class="${isExpanded ? '' : 'hidden'}">
                <div class="px-5 py-4 bg-white border-t border-tcsc-gray-100">
                    ${renderDefaultsEditor(index, day.defaults)}
                </div>
            </div>
        </div>`;
    }).join('');
}

function renderDefaultsSummary(defaults) {
    if (!defaults) return '— not configured';
    const parts = [];
    if (defaults.location_id) {
        const loc = locationsData.find(l => l.id === defaults.location_id);
        if (loc) parts.push(loc.name);
    }
    const actNames = (defaults.activity_ids || []).map(id => activitiesData.find(a => a.id === id)?.name).filter(Boolean);
    if (actNames.length) parts.push(actNames.join(', '));
    const typeNames = (defaults.type_ids || []).map(id => typesData.find(t => t.id === id)?.name).filter(Boolean);
    if (typeNames.length) parts.push(typeNames.join(', '));
    if (defaults.coach_ids?.length) parts.push(`${defaults.coach_ids.length} coach${defaults.coach_ids.length > 1 ? 'es' : ''}`);
    if (defaults.is_dark_practice) parts.push('Dark');
    if (defaults.warmup || defaults.workout || defaults.cooldown) parts.push('Workout template');
    return parts.length ? '— ' + parts.join(' · ') : '— not configured';
}

function renderDefaultsEditor(index, defaults) {
    const d = defaults || {};
    return `
        <!-- Section: Location & Options -->
        <div class="mb-5 pb-5 border-b border-tcsc-gray-100">
            <h4 class="text-xs font-semibold text-tcsc-navy uppercase tracking-wide mb-3">Location & Options</h4>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label class="block mb-1.5 font-medium text-sm text-gray-700">Location</label>
                    <select onchange="updateDefault(${index}, 'location_id', this.value ? parseInt(this.value) : null)"
                        class="w-full py-2.5 px-3 border border-gray-300 rounded-md text-sm text-gray-800 bg-white focus:outline-none focus:border-tcsc-navy focus:ring-2 focus:ring-tcsc-navy/10">
                        <option value="">None</option>
                        ${locationsData.map(l => `<option value="${l.id}" ${d.location_id === l.id ? 'selected' : ''}>${l.name}${l.spot ? ' — ' + l.spot : ''}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block mb-1.5 font-medium text-sm text-gray-700">Social Location</label>
                    <select onchange="updateDefault(${index}, 'social_location_id', this.value ? parseInt(this.value) : null)"
                        class="w-full py-2.5 px-3 border border-gray-300 rounded-md text-sm text-gray-800 bg-white focus:outline-none focus:border-tcsc-navy focus:ring-2 focus:ring-tcsc-navy/10">
                        <option value="">None</option>
                        ${socialLocationsData.map(l => `<option value="${l.id}" ${d.social_location_id === l.id ? 'selected' : ''}>${l.name}</option>`).join('')}
                    </select>
                </div>
                <div class="flex items-end pb-1">
                    <label class="toggle flex items-center gap-3 cursor-pointer px-3 py-2 bg-gray-50 border border-gray-200 rounded-md transition-all hover:bg-gray-100 w-full">
                        <input type="checkbox" ${d.is_dark_practice ? 'checked' : ''} onchange="updateDefault(${index}, 'is_dark_practice', this.checked)" class="hidden defaults-toggle-input">
                        <span class="defaults-toggle-slider"></span>
                        <span class="text-sm text-gray-700">Dark practice</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Section: Workout Template -->
        <div class="mb-5 pb-5 border-b border-tcsc-gray-100">
            <h4 class="text-xs font-semibold text-tcsc-navy uppercase tracking-wide mb-3">Workout Template</h4>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label class="block mb-1.5 font-medium text-sm text-gray-700">Warmup</label>
                    <textarea onchange="updateDefault(${index}, 'warmup', this.value || null)"
                        class="w-full py-2.5 px-3 border border-gray-300 rounded-md text-sm text-gray-800 bg-white min-h-[80px] resize-y focus:outline-none focus:border-tcsc-navy focus:ring-2 focus:ring-tcsc-navy/10"
                        placeholder="e.g., 15 min easy ski, focus on balance">${(d.warmup || '').replace(/</g, '&lt;')}</textarea>
                </div>
                <div>
                    <label class="block mb-1.5 font-medium text-sm text-gray-700">Workout</label>
                    <textarea onchange="updateDefault(${index}, 'workout', this.value || null)"
                        class="w-full py-2.5 px-3 border border-gray-300 rounded-md text-sm text-gray-800 bg-white min-h-[80px] resize-y focus:outline-none focus:border-tcsc-navy focus:ring-2 focus:ring-tcsc-navy/10"
                        placeholder="e.g., 5 stations, 6 exercises per station, 2 sets">${(d.workout || '').replace(/</g, '&lt;')}</textarea>
                </div>
                <div>
                    <label class="block mb-1.5 font-medium text-sm text-gray-700">Cooldown</label>
                    <textarea onchange="updateDefault(${index}, 'cooldown', this.value || null)"
                        class="w-full py-2.5 px-3 border border-gray-300 rounded-md text-sm text-gray-800 bg-white min-h-[80px] resize-y focus:outline-none focus:border-tcsc-navy focus:ring-2 focus:ring-tcsc-navy/10"
                        placeholder="e.g., 10 min easy, stretching">${(d.cooldown || '').replace(/</g, '&lt;')}</textarea>
                </div>
            </div>
        </div>

        <!-- Section: Tags & Staff -->
        <div class="mb-4">
            <h4 class="text-xs font-semibold text-tcsc-navy uppercase tracking-wide mb-3">Tags & Staff</h4>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                    <label class="block mb-1.5 font-medium text-sm text-gray-700">Activities</label>
                    <div class="grid grid-cols-[repeat(auto-fill,minmax(140px,1fr))] gap-2">
                        ${activitiesData.map(a => `
                            <label class="flex items-center gap-2 py-1 cursor-pointer hover:bg-gray-50 rounded px-1 transition-colors">
                                <input type="checkbox" ${(d.activity_ids || []).includes(a.id) ? 'checked' : ''}
                                    onchange="updateDefaultArray(${index}, 'activity_ids', ${a.id}, this.checked)"
                                    class="w-[18px] h-[18px] cursor-pointer rounded border-tcsc-gray-100 text-tcsc-navy focus:ring-tcsc-navy/20">
                                <span class="text-sm text-gray-700">${a.name}</span>
                            </label>
                        `).join('')}
                        ${activitiesData.length === 0 ? '<span class="text-sm text-gray-400 italic">No activities configured</span>' : ''}
                    </div>
                </div>
                <div>
                    <label class="block mb-1.5 font-medium text-sm text-gray-700">Practice Types</label>
                    <div class="grid grid-cols-[repeat(auto-fill,minmax(140px,1fr))] gap-2">
                        ${typesData.map(t => `
                            <label class="flex items-center gap-2 py-1 cursor-pointer hover:bg-gray-50 rounded px-1 transition-colors">
                                <input type="checkbox" ${(d.type_ids || []).includes(t.id) ? 'checked' : ''}
                                    onchange="updateDefaultArray(${index}, 'type_ids', ${t.id}, this.checked)"
                                    class="w-[18px] h-[18px] cursor-pointer rounded border-tcsc-gray-100 text-tcsc-navy focus:ring-tcsc-navy/20">
                                <span class="text-sm text-gray-700">${t.name}</span>
                            </label>
                        `).join('')}
                        ${typesData.length === 0 ? '<span class="text-sm text-gray-400 italic">No types configured</span>' : ''}
                    </div>
                </div>
                <div>
                    <label class="block mb-1.5 font-medium text-sm text-gray-700">Coaches</label>
                    <div class="grid grid-cols-[repeat(auto-fill,minmax(140px,1fr))] gap-2">
                        ${coachesData.map(c => `
                            <label class="flex items-center gap-2 py-1 cursor-pointer hover:bg-gray-50 rounded px-1 transition-colors">
                                <input type="checkbox" ${(d.coach_ids || []).includes(c.id) ? 'checked' : ''}
                                    onchange="updateDefaultArray(${index}, 'coach_ids', ${c.id}, this.checked)"
                                    class="w-[18px] h-[18px] cursor-pointer rounded border-tcsc-gray-100 text-tcsc-navy focus:ring-tcsc-navy/20">
                                <span class="text-sm text-gray-700">${c.name}</span>
                            </label>
                        `).join('')}
                        ${coachesData.length === 0 ? '<span class="text-sm text-gray-400 italic">No coaches configured</span>' : ''}
                    </div>
                </div>
            </div>
        </div>

        <!-- Clear button -->
        <div class="pt-3 border-t border-tcsc-gray-100 flex justify-end">
            <button type="button" onclick="clearDefaults(${index})"
                class="tbl-btn tbl-btn-danger">Clear All Defaults</button>
        </div>
    `;
}

function toggleDefaults(index) {
    const editor = document.getElementById('defaults-editor-' + index);
    const chevron = document.getElementById('defaults-chevron-' + index);
    if (!editor) return;
    const isHidden = editor.classList.contains('hidden');
    editor.classList.toggle('hidden');
    if (chevron) chevron.classList.toggle('rotate-90', isHidden);
    practiceDays[index]._expanded = isHidden;
}

function updateDefault(index, field, value) {
    if (!practiceDays[index].defaults) {
        practiceDays[index].defaults = {};
    }
    if (value === null || value === '' || value === false) {
        delete practiceDays[index].defaults[field];
    } else {
        practiceDays[index].defaults[field] = value;
    }
    if (Object.keys(practiceDays[index].defaults).length === 0) {
        practiceDays[index].defaults = null;
    }
    // Update summary without full re-render to preserve focus
    const summaryEl = document.querySelector(`[data-index="${index}"] .defaults-summary-text`);
    // Full re-render only on dropdown/toggle changes (not text)
    if (['location_id', 'social_location_id', 'is_dark_practice'].includes(field)) {
        renderPracticeDays();
    }
}

function updateDefaultArray(index, field, id, checked) {
    if (!practiceDays[index].defaults) {
        practiceDays[index].defaults = {};
    }
    const arr = practiceDays[index].defaults[field] || [];
    if (checked && !arr.includes(id)) {
        arr.push(id);
    } else if (!checked) {
        const idx = arr.indexOf(id);
        if (idx >= 0) arr.splice(idx, 1);
    }
    if (arr.length > 0) {
        practiceDays[index].defaults[field] = arr;
    } else {
        delete practiceDays[index].defaults[field];
    }
    if (Object.keys(practiceDays[index].defaults).length === 0) {
        practiceDays[index].defaults = null;
    }
}

function clearDefaults(index) {
    practiceDays[index].defaults = null;
    renderPracticeDays();
}

function updatePracticeDay(index, field, value) {
    if (practiceDays[index]) {
        practiceDays[index][field] = value;
    }
}

function addPracticeDay() {
    practiceDays.push({
        day: 'monday',
        time: '18:00',
        active: true
    });
    renderPracticeDays();
}

function removePracticeDay(index) {
    practiceDays.splice(index, 1);
    renderPracticeDays();
}

async function savePracticeDays() {
    try {
        // Strip internal state (_expanded) before saving
        const cleanDays = practiceDays.map(({_expanded, ...rest}) => rest);
        const response = await fetch('/admin/practices/settings/practice-days', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ practice_days: cleanDays })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            practiceDays = result.practice_days;
            showToast('Practice days saved successfully', 'success');
        } else {
            showToast(result.error || 'Failed to save practice days', 'error');
        }
    } catch (err) {
        showToast('Error saving practice days: ' + err.message, 'error');
    }
}

// ============================================================================
// Helpers
// ============================================================================
function formatJsonArray(val) {
    if (!val || !Array.isArray(val) || val.length === 0) {
        return '<span class="text-gray-500">—</span>';
    }
    return `<span class="text-sm text-gray-500">${val.join(', ')}</span>`;
}

function formatCount(count) {
    const hasItems = count > 0;
    return `<span class="inline-flex items-center justify-center min-w-[24px] h-6 px-2 rounded-full text-xs font-medium ${hasItems ? 'bg-tcsc-secondary text-tcsc-navy' : 'bg-gray-100 text-gray-700'}">${count || 0}</span>`;
}

function formatDeleteButton(cell, entityType, countField) {
    const data = cell.getRow().getData();
    const count = data[countField] || 0;
    const canDelete = count === 0;
    const funcName = `delete${entityType}`;

    if (canDelete) {
        return `<div class="tbl-actions justify-center">
            <button class="tbl-btn tbl-btn-danger" onclick="${funcName}(${data.id}, '${data.name.replace(/'/g, "\\'")}')">Delete</button>
        </div>`;
    }
    return `<div class="tbl-actions justify-center">
        <button class="tbl-btn tbl-btn-secondary" disabled title="Cannot delete - has references">Delete</button>
    </div>`;
}

</script>
{% endblock %}
