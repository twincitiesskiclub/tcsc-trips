{% extends 'admin/admin_base.html' %}

{% block title %}Practice Calendar{% endblock %}

{% block extra_css %}
<style>
/* Calendar Grid - uses CSS grid which works better with specific sizing */
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e4e7ec;
    border: 1px solid #e4e7ec;
    border-radius: 8px;
    overflow: hidden;
}

/* Practice item status colors - dynamically generated via JS */
.practice-item.status-scheduled {
    background: #3b82f6;
}

.practice-item.status-confirmed {
    background: #10b981;
}

.practice-item.status-cancelled {
    background: #ef4444;
}

.practice-item.status-completed {
    background: #6b7280;
}

/* Legend status colors */
.legend-color.status-scheduled {
    background: #3b82f6;
}

.legend-color.status-confirmed {
    background: #10b981;
}

.legend-color.status-cancelled {
    background: #ef4444;
}

.legend-color.status-completed {
    background: #6b7280;
}
</style>
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold text-tcsc-navy">Practice Calendar</h1>
    <div class="flex gap-2">
        <a href="{{ url_for('admin_practices.practices_list') }}" class="bg-tcsc-navy text-white px-4 py-2 rounded-tcsc text-sm font-medium hover:opacity-90 transition-all">List View</a>
        <a href="{{ url_for('admin.get_admin_page') }}" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-tcsc text-sm font-medium hover:bg-gray-300 transition-all">Back to Dashboard</a>
    </div>
</div>

<div class="bg-white p-6 rounded-tcsc border border-tcsc-gray-100">
    <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-4">
            <button id="prev-month" onclick="changeMonth(-1)" class="inline-flex items-center justify-center h-9 px-4 border border-gray-300 rounded-md bg-white text-sm font-medium text-gray-700 cursor-pointer transition-all hover:bg-gray-50 hover:border-tcsc-navy">&larr; Previous</button>
            <span class="month-label font-semibold text-base text-tcsc-navy min-w-[150px] text-center" id="current-month"></span>
            <button id="next-month" onclick="changeMonth(1)" class="inline-flex items-center justify-center h-9 px-4 border border-gray-300 rounded-md bg-white text-sm font-medium text-gray-700 cursor-pointer transition-all hover:bg-gray-50 hover:border-tcsc-navy">Next &rarr;</button>
        </div>
        <div class="flex gap-2">
            <button class="bg-gray-200 text-gray-600 px-4 py-2 rounded-tcsc text-sm font-medium hover:bg-gray-300 transition-all" onclick="goToToday()">Today</button>
        </div>
    </div>

    <div id="calendar-grid" class="calendar-grid">
        <!-- Calendar headers -->
        <div class="bg-tcsc-navy text-white p-3 text-center text-sm font-semibold">Sunday</div>
        <div class="bg-tcsc-navy text-white p-3 text-center text-sm font-semibold">Monday</div>
        <div class="bg-tcsc-navy text-white p-3 text-center text-sm font-semibold">Tuesday</div>
        <div class="bg-tcsc-navy text-white p-3 text-center text-sm font-semibold">Wednesday</div>
        <div class="bg-tcsc-navy text-white p-3 text-center text-sm font-semibold">Thursday</div>
        <div class="bg-tcsc-navy text-white p-3 text-center text-sm font-semibold">Friday</div>
        <div class="bg-tcsc-navy text-white p-3 text-center text-sm font-semibold">Saturday</div>
        <!-- Days populated via JavaScript -->
    </div>

    <div class="flex gap-5 mt-5 p-4 bg-gray-50 rounded-md">
        <div class="flex items-center gap-2 text-sm text-gray-700">
            <div class="legend-color status-scheduled w-5 h-5 rounded"></div>
            <span>Scheduled</span>
        </div>
        <div class="flex items-center gap-2 text-sm text-gray-700">
            <div class="legend-color status-confirmed w-5 h-5 rounded"></div>
            <span>Confirmed</span>
        </div>
        <div class="flex items-center gap-2 text-sm text-gray-700">
            <div class="legend-color status-cancelled w-5 h-5 rounded"></div>
            <span>Cancelled</span>
        </div>
        <div class="flex items-center gap-2 text-sm text-gray-700">
            <div class="legend-color status-completed w-5 h-5 rounded"></div>
            <span>Completed</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDate = new Date();
let practices = [];

document.addEventListener('DOMContentLoaded', async () => {
    await loadPractices();
    renderCalendar();
});

async function loadPractices() {
    try {
        const response = await fetch('/admin/practices/data');
        const data = await response.json();
        practices = data.practices;
    } catch (err) {
        console.error('Error loading practices:', err);
    }
}

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update month label
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    // Get previous month's last days
    const prevMonthLastDay = new Date(year, month, 0).getDate();

    // Clear existing calendar days (keep headers)
    const grid = document.getElementById('calendar-grid');
    while (grid.children.length > 7) {
        grid.removeChild(grid.lastChild);
    }

    // Add previous month's trailing days
    for (let i = startingDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const dayDiv = createDayCell(day, year, month - 1, true);
        grid.appendChild(dayDiv);
    }

    // Add current month's days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = createDayCell(day, year, month, false);
        grid.appendChild(dayDiv);
    }

    // Add next month's leading days
    const totalCells = grid.children.length - 7; // Subtract headers
    const remainingCells = (Math.ceil(totalCells / 7) * 7) - totalCells;
    for (let day = 1; day <= remainingCells; day++) {
        const dayDiv = createDayCell(day, year, month + 1, true);
        grid.appendChild(dayDiv);
    }
}

function createDayCell(day, year, month, isOtherMonth) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'bg-white min-h-[100px] p-2 relative';
    if (isOtherMonth) {
        dayDiv.className += ' bg-gray-50';
    }

    // Check if today
    const today = new Date();
    const cellDate = new Date(year, month, day);
    if (cellDate.toDateString() === today.toDateString()) {
        dayDiv.className += ' bg-blue-50';
    }

    // Day number
    const dayNumber = document.createElement('div');
    dayNumber.className = 'font-semibold text-sm mb-1';
    if (isOtherMonth) {
        dayNumber.className += ' text-gray-400';
    } else if (cellDate.toDateString() === today.toDateString()) {
        dayNumber.className += ' text-tcsc-navy';
    } else {
        dayNumber.className += ' text-gray-800';
    }
    dayNumber.textContent = day;
    dayDiv.appendChild(dayNumber);

    // Filter practices for this day
    const dayPractices = practices.filter(p => {
        const practiceDate = new Date(p.date);
        return practiceDate.getFullYear() === year &&
               practiceDate.getMonth() === month &&
               practiceDate.getDate() === day;
    });

    // Add practice items
    if (dayPractices.length > 0) {
        dayPractices.forEach(practice => {
            const practiceDiv = document.createElement('a');
            practiceDiv.className = `practice-item block px-1.5 py-1 mb-1 rounded text-xs font-medium text-white cursor-pointer no-underline transition-all hover:opacity-85 hover:-translate-y-px overflow-hidden text-ellipsis whitespace-nowrap status-${practice.status}`;
            practiceDiv.href = `/admin/practices/${practice.id}`;

            // Format time
            const practiceDate = new Date(practice.date);
            const timeStr = practiceDate.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            practiceDiv.innerHTML = `<span class="font-semibold mr-1">${timeStr}</span>${practice.location_name}`;
            dayDiv.appendChild(practiceDiv);
        });
    }

    return dayDiv;
}

function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderCalendar();
}

function goToToday() {
    currentDate = new Date();
    renderCalendar();
}
</script>
{% endblock %}
