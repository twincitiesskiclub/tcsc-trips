{% extends 'admin/admin_base.html' %}

{% block title %}Practice Calendar{% endblock %}

{% block extra_css %}
<style>
/* Calendar Container */
.calendar-container {
    background: white;
    border-radius: var(--r);
    padding: 24px;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e4e7ec;
}

.calendar-title {
    font: 600 20px var(--f);
    color: var(--p);
    margin: 0;
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: 16px;
}

.calendar-nav button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 36px;
    padding: 0 16px;
    border: 1px solid #d0d5dd;
    border-radius: 6px;
    background: white;
    font: 500 14px var(--f);
    color: #344054;
    cursor: pointer;
    transition: all 0.15s;
}

.calendar-nav button:hover {
    background: #f9fafb;
    border-color: var(--p);
}

.month-label {
    font: 600 16px var(--f);
    color: var(--p);
    min-width: 150px;
    text-align: center;
}

/* Calendar Grid */
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e4e7ec;
    border: 1px solid #e4e7ec;
    border-radius: 8px;
    overflow: hidden;
}

.calendar-day-header {
    background: var(--p);
    color: white;
    padding: 12px;
    text-align: center;
    font: 600 13px var(--f);
}

.calendar-day {
    background: white;
    min-height: 100px;
    padding: 8px;
    position: relative;
}

.calendar-day.other-month {
    background: #f9fafb;
}

.calendar-day.today {
    background: #eff6ff;
}

.day-number {
    font: 600 14px var(--f);
    color: #1d2939;
    margin-bottom: 4px;
}

.calendar-day.other-month .day-number {
    color: #9ca3af;
}

.calendar-day.today .day-number {
    color: var(--p);
}

/* Practice Items */
.practice-item {
    display: block;
    padding: 4px 6px;
    margin-bottom: 4px;
    border-radius: 4px;
    font: 500 11px var(--f);
    color: white;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.15s;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.practice-item:hover {
    opacity: 0.85;
    transform: translateY(-1px);
}

.practice-item.status-scheduled {
    background: #3b82f6;
}

.practice-item.status-confirmed {
    background: #10b981;
}

.practice-item.status-cancelled {
    background: #ef4444;
}

.practice-item.status-completed {
    background: #6b7280;
}

.practice-time {
    font-weight: 600;
    margin-right: 4px;
}

/* Legend */
.calendar-legend {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    padding: 16px;
    background: #f9fafb;
    border-radius: 6px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font: 400 13px var(--f);
    color: #344054;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

/* Toolbar */
.calendar-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.toolbar-actions {
    display: flex;
    gap: 8px;
}

/* Loading State */
.calendar-loading {
    text-align: center;
    padding: 40px;
    color: #6b7280;
}

/* Empty State */
.no-practices {
    text-align: center;
    padding: 12px;
    color: #6b7280;
    font-size: 12px;
    font-style: italic;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Practice Calendar</h1>
    <div class="admin-actions">
        <a href="{{ url_for('admin_practices.practices_list') }}" class="button">List View</a>
        <a href="{{ url_for('admin.get_admin_page') }}" class="button button-secondary">Back to Dashboard</a>
    </div>
</div>

<div class="calendar-container">
    <div class="calendar-toolbar">
        <div class="calendar-nav">
            <button id="prev-month" onclick="changeMonth(-1)">← Previous</button>
            <span class="month-label" id="current-month"></span>
            <button id="next-month" onclick="changeMonth(1)">Next →</button>
        </div>
        <div class="toolbar-actions">
            <button class="button button-secondary" onclick="goToToday()">Today</button>
        </div>
    </div>

    <div id="calendar-grid" class="calendar-grid">
        <!-- Calendar headers -->
        <div class="calendar-day-header">Sunday</div>
        <div class="calendar-day-header">Monday</div>
        <div class="calendar-day-header">Tuesday</div>
        <div class="calendar-day-header">Wednesday</div>
        <div class="calendar-day-header">Thursday</div>
        <div class="calendar-day-header">Friday</div>
        <div class="calendar-day-header">Saturday</div>
        <!-- Days populated via JavaScript -->
    </div>

    <div class="calendar-legend">
        <div class="legend-item">
            <div class="legend-color status-scheduled"></div>
            <span>Scheduled</span>
        </div>
        <div class="legend-item">
            <div class="legend-color status-confirmed"></div>
            <span>Confirmed</span>
        </div>
        <div class="legend-item">
            <div class="legend-color status-cancelled"></div>
            <span>Cancelled</span>
        </div>
        <div class="legend-item">
            <div class="legend-color status-completed"></div>
            <span>Completed</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDate = new Date();
let practices = [];

document.addEventListener('DOMContentLoaded', async () => {
    await loadPractices();
    renderCalendar();
});

async function loadPractices() {
    try {
        const response = await fetch('/admin/practices/data');
        const data = await response.json();
        practices = data.practices;
    } catch (err) {
        console.error('Error loading practices:', err);
    }
}

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update month label
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();

    // Get previous month's last days
    const prevMonthLastDay = new Date(year, month, 0).getDate();

    // Clear existing calendar days (keep headers)
    const grid = document.getElementById('calendar-grid');
    while (grid.children.length > 7) {
        grid.removeChild(grid.lastChild);
    }

    // Add previous month's trailing days
    for (let i = startingDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const dayDiv = createDayCell(day, year, month - 1, true);
        grid.appendChild(dayDiv);
    }

    // Add current month's days
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = createDayCell(day, year, month, false);
        grid.appendChild(dayDiv);
    }

    // Add next month's leading days
    const totalCells = grid.children.length - 7; // Subtract headers
    const remainingCells = (Math.ceil(totalCells / 7) * 7) - totalCells;
    for (let day = 1; day <= remainingCells; day++) {
        const dayDiv = createDayCell(day, year, month + 1, true);
        grid.appendChild(dayDiv);
    }
}

function createDayCell(day, year, month, isOtherMonth) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';
    if (isOtherMonth) {
        dayDiv.className += ' other-month';
    }

    // Check if today
    const today = new Date();
    const cellDate = new Date(year, month, day);
    if (cellDate.toDateString() === today.toDateString()) {
        dayDiv.className += ' today';
    }

    // Day number
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = day;
    dayDiv.appendChild(dayNumber);

    // Filter practices for this day
    const dayPractices = practices.filter(p => {
        const practiceDate = new Date(p.date);
        return practiceDate.getFullYear() === year &&
               practiceDate.getMonth() === month &&
               practiceDate.getDate() === day;
    });

    // Add practice items
    if (dayPractices.length > 0) {
        dayPractices.forEach(practice => {
            const practiceDiv = document.createElement('a');
            practiceDiv.className = `practice-item status-${practice.status}`;
            practiceDiv.href = `/admin/practices/${practice.id}`;

            // Format time
            const practiceDate = new Date(practice.date);
            const timeStr = practiceDate.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            practiceDiv.innerHTML = `<span class="practice-time">${timeStr}</span>${practice.location_name}`;
            dayDiv.appendChild(practiceDiv);
        });
    }

    return dayDiv;
}

function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderCalendar();
}

function goToToday() {
    currentDate = new Date();
    renderCalendar();
}
</script>
{% endblock %}
