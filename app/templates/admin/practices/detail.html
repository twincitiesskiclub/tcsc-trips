{% extends 'admin/admin_base.html' %}

{% block title %}{{ 'Edit Practice' if practice else 'New Practice' }}{% endblock %}

{% block extra_css %}
<style>
/* Practice Edit Form Styles */
.practice-form-container {
    background: white;
    border-radius: var(--r);
    padding: 24px;
    max-width: 900px;
}

.form-section {
    margin-bottom: 28px;
    padding-bottom: 28px;
    border-bottom: 1px solid #e4e7ec;
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.form-section-title {
    font: 600 16px var(--f);
    color: var(--p);
    margin: 0 0 16px 0;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font: 500 13px var(--f);
    color: #344054;
}

.form-group input[type="text"],
.form-group input[type="datetime-local"],
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d0d5dd;
    border-radius: 6px;
    font: 400 14px var(--f);
    color: #1d2939;
    background: white;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--p);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

/* Checkbox Groups */
.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-top: 8px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.checkbox-item label {
    margin-bottom: 0;
    font: 400 14px var(--f);
    color: #344054;
    cursor: pointer;
}

/* Single Checkboxes */
.checkbox-single {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
}

.checkbox-single input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.checkbox-single label {
    margin-bottom: 0;
    font: 400 14px var(--f);
    color: #344054;
    cursor: pointer;
}

/* Form Actions */
.form-actions {
    display: flex;
    gap: 12px;
    margin-top: 28px;
    padding-top: 20px;
    border-top: 1px solid #e4e7ec;
}

/* Validation Error */
.error-message {
    color: #dc2626;
    font-size: 13px;
    margin-top: 4px;
}

.form-group.has-error input,
.form-group.has-error select,
.form-group.has-error textarea {
    border-color: #dc2626;
}

/* Loading State */
.form-loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Toast */
.toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    border-radius: var(--r);
    background: var(--p);
    color: white;
    font: 500 14px var(--f);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
}

.toast.error {
    background: #dc2626;
}

.toast.success {
    background: #16a34a;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>{{ 'Edit Practice' if practice else 'New Practice' }}</h1>
    <div class="admin-actions">
        <a href="{{ url_for('admin_practices.practices_list') }}" class="button button-secondary">Back to Practices</a>
    </div>
</div>

<div class="practice-form-container">
    <form id="practice-form" method="POST" action="{{ url_for('admin_practices.edit_practice', practice_id=practice.id) if practice else url_for('admin_practices.create_practice') }}">

        <!-- Basic Information -->
        <div class="form-section">
            <h2 class="form-section-title">Basic Information</h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="date">Date & Time *</label>
                    <input type="datetime-local" id="date" name="date"
                           value="{{ practice.date.strftime('%Y-%m-%dT%H:%M') if practice else '' }}" required>
                </div>

                <div class="form-group">
                    <label for="location_id">Location *</label>
                    <select id="location_id" name="location_id" required>
                        <option value="">Select a location...</option>
                    </select>
                </div>
            </div>

            {% if practice %}
            <div class="form-group">
                <label for="status">Status</label>
                <select id="status" name="status">
                    <option value="scheduled" {% if practice.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
                    <option value="confirmed" {% if practice.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="cancelled" {% if practice.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    <option value="completed" {% if practice.status == 'completed' %}selected{% endif %}>Completed</option>
                </select>
            </div>
            {% endif %}
        </div>

        <!-- Practice Details -->
        <div class="form-section">
            <h2 class="form-section-title">Practice Details</h2>

            <div class="form-group">
                <label>Activities</label>
                <div id="activities-checkboxes" class="checkbox-grid">
                    <!-- Populated via JavaScript -->
                </div>
            </div>

            <div class="form-group">
                <label>Practice Types</label>
                <div id="types-checkboxes" class="checkbox-grid">
                    <!-- Populated via JavaScript -->
                </div>
            </div>
        </div>

        <!-- Coaches & Leads -->
        <div class="form-section">
            <h2 class="form-section-title">Coaches & Leads</h2>

            <div class="form-group">
                <label>Coaches</label>
                <div id="coaches-checkboxes" class="checkbox-grid">
                    <!-- Populated via JavaScript -->
                </div>
            </div>

            <div class="form-group">
                <label>Leads</label>
                <div id="leads-checkboxes" class="checkbox-grid">
                    <!-- Populated via JavaScript -->
                </div>
            </div>
        </div>

        <!-- Workout Descriptions -->
        <div class="form-section">
            <h2 class="form-section-title">Workout Plan</h2>

            <div class="form-group">
                <label for="warmup_description">Warmup Description</label>
                <textarea id="warmup_description" name="warmup_description"
                          placeholder="Describe the warmup routine...">{{ practice.warmup_description if practice else '' }}</textarea>
            </div>

            <div class="form-group">
                <label for="workout_description">Workout Description</label>
                <textarea id="workout_description" name="workout_description"
                          placeholder="Describe the main workout...">{{ practice.workout_description if practice else '' }}</textarea>
            </div>

            <div class="form-group">
                <label for="cooldown_description">Cooldown Description</label>
                <textarea id="cooldown_description" name="cooldown_description"
                          placeholder="Describe the cooldown routine...">{{ practice.cooldown_description if practice else '' }}</textarea>
            </div>
        </div>

        <!-- Additional Options -->
        <div class="form-section">
            <h2 class="form-section-title">Additional Options</h2>

            <div class="checkbox-single">
                <input type="checkbox" id="has_social" name="has_social"
                       {% if practice and practice.has_social %}checked{% endif %}>
                <label for="has_social">Has Post-Practice Social</label>
            </div>

            <div class="checkbox-single">
                <input type="checkbox" id="is_dark_practice" name="is_dark_practice"
                       {% if practice and practice.is_dark_practice %}checked{% endif %}>
                <label for="is_dark_practice">Dark Practice (lights required)</label>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="submit" class="button">{{ 'Save Changes' if practice else 'Create Practice' }}</button>
            <a href="{{ url_for('admin_practices.practices_list') }}" class="button button-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let locations = [];
let activities = [];
let types = [];
let coachesData = [];
let leadsData = [];
const practiceId = {{ practice.id if practice else 'null' }};
const practiceActivities = {{ (practice.activities | map(attribute='id') | list) | tojson if practice else '[]' }};
const practiceTypes = {{ (practice.practice_types | map(attribute='id') | list) | tojson if practice else '[]' }};
const practiceCoaches = {{ (practice.leads | selectattr('role', 'equalto', 'coach') | map(attribute='user_id') | select | list) | tojson if practice else '[]' }};
const practiceLeads = {{ (practice.leads | selectattr('role', 'equalto', 'lead') | map(attribute='user_id') | select | list) | tojson if practice else '[]' }};

document.addEventListener('DOMContentLoaded', async () => {
    await loadFormData();
    populateForm();
});

async function loadFormData() {
    try {
        // Load locations
        const locationsResp = await fetch('/admin/practices/locations/data');
        const locationsData = await locationsResp.json();
        locations = locationsData.locations;

        // Load activities
        const activitiesResp = await fetch('/admin/practices/activities/data');
        const activitiesData = await activitiesResp.json();
        activities = activitiesData.activities;

        // Load types
        const typesResp = await fetch('/admin/practices/types/data');
        const typesData = await typesResp.json();
        types = typesData.types;

        // Load coaches and leads (users with appropriate tags)
        const peopleResp = await fetch('/admin/practices/people/data');
        const peopleData = await peopleResp.json();
        coachesData = peopleData.coaches || [];
        leadsData = peopleData.leads || [];
    } catch (err) {
        console.error('Error loading form data:', err);
        showToast('Error loading form data', 'error');
    }
}

function populateForm() {
    // Populate locations dropdown
    const locationSelect = document.getElementById('location_id');
    locations.forEach(loc => {
        const option = document.createElement('option');
        option.value = loc.id;
        option.textContent = loc.name + (loc.spot ? ` - ${loc.spot}` : '');
        {% if practice %}
        if (loc.id === {{ practice.location_id }}) {
            option.selected = true;
        }
        {% endif %}
        locationSelect.appendChild(option);
    });

    // Populate activities checkboxes
    const activitiesContainer = document.getElementById('activities-checkboxes');
    activities.forEach(activity => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `activity_${activity.id}`;
        checkbox.name = 'activity_ids';
        checkbox.value = activity.id;
        if (practiceActivities.includes(activity.id)) {
            checkbox.checked = true;
        }

        const label = document.createElement('label');
        label.htmlFor = `activity_${activity.id}`;
        label.textContent = activity.name;

        div.appendChild(checkbox);
        div.appendChild(label);
        activitiesContainer.appendChild(div);
    });

    // Populate types checkboxes
    const typesContainer = document.getElementById('types-checkboxes');
    types.forEach(type => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `type_${type.id}`;
        checkbox.name = 'type_ids';
        checkbox.value = type.id;
        if (practiceTypes.includes(type.id)) {
            checkbox.checked = true;
        }

        const label = document.createElement('label');
        label.htmlFor = `type_${type.id}`;
        label.textContent = type.name;

        div.appendChild(checkbox);
        div.appendChild(label);
        typesContainer.appendChild(div);
    });

    // Populate coaches checkboxes
    const coachesContainer = document.getElementById('coaches-checkboxes');
    coachesData.forEach(coach => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `coach_${coach.id}`;
        checkbox.name = 'coach_ids';
        checkbox.value = coach.id;
        if (practiceCoaches.includes(coach.id)) {
            checkbox.checked = true;
        }

        const label = document.createElement('label');
        label.htmlFor = `coach_${coach.id}`;
        label.textContent = coach.name;

        div.appendChild(checkbox);
        div.appendChild(label);
        coachesContainer.appendChild(div);
    });

    // Populate leads checkboxes
    const leadsContainer = document.getElementById('leads-checkboxes');
    leadsData.forEach(lead => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `lead_${lead.id}`;
        checkbox.name = 'lead_ids';
        checkbox.value = lead.id;
        if (practiceLeads.includes(lead.id)) {
            checkbox.checked = true;
        }

        const label = document.createElement('label');
        label.htmlFor = `lead_${lead.id}`;
        label.textContent = lead.name;

        div.appendChild(checkbox);
        div.appendChild(label);
        leadsContainer.appendChild(div);
    });
}

// Handle form submission
document.getElementById('practice-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    // Collect checked activities, types, coaches, and leads
    const activityIds = Array.from(form.querySelectorAll('input[name="activity_ids"]:checked'))
        .map(cb => parseInt(cb.value));
    const typeIds = Array.from(form.querySelectorAll('input[name="type_ids"]:checked'))
        .map(cb => parseInt(cb.value));
    const coachIds = Array.from(form.querySelectorAll('input[name="coach_ids"]:checked'))
        .map(cb => parseInt(cb.value));
    const leadIds = Array.from(form.querySelectorAll('input[name="lead_ids"]:checked'))
        .map(cb => parseInt(cb.value));

    // Build JSON payload
    const data = {
        date: formData.get('date'),
        location_id: parseInt(formData.get('location_id')),
        warmup_description: formData.get('warmup_description') || null,
        workout_description: formData.get('workout_description') || null,
        cooldown_description: formData.get('cooldown_description') || null,
        has_social: formData.get('has_social') === 'on',
        is_dark_practice: formData.get('is_dark_practice') === 'on',
        activity_ids: activityIds,
        type_ids: typeIds,
        coach_ids: coachIds,
        lead_ids: leadIds
    };

    if (practiceId) {
        data.status = formData.get('status');
    }

    // Show loading state
    form.classList.add('form-loading');

    try {
        const response = await fetch(form.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.success) {
            showToast(result.message || 'Practice saved successfully', 'success');
            setTimeout(() => {
                window.location.href = '/admin/practices';
            }, 1000);
        } else {
            showToast(result.error || 'Failed to save practice', 'error');
            form.classList.remove('form-loading');
        }
    } catch (err) {
        console.error('Error saving practice:', err);
        showToast('Error saving practice: ' + err.message, 'error');
        form.classList.remove('form-loading');
    }
});

function showToast(message, type = 'info') {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
