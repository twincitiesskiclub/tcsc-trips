{% extends 'admin/admin_base.html' %}
{% block title %}Role Management{% endblock %}
{% block extra_css %}
<style>
/* Emoji preview in grid */
.role-emoji-preview {
    font-size: 20px;
    text-align: center;
}

/* Gradient preview in grid */
.gradient-preview {
    display: inline-block;
    width: 100px;
    height: 24px;
    border-radius: 4px;
    vertical-align: middle;
}

/* User count badge */
.user-count-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 24px;
    height: 24px;
    padding: 0 8px;
    background: #f2f4f7;
    border-radius: 12px;
    font-weight: 500;
    font-size: 12px;
    color: #344054;
}

.user-count-badge.has-users {
    background: #d4f5e9;
    color: #1c2c44;
}

/* Inline editor styling */
.tabulator-edit-box {
    padding: 4px 8px;
    border: 2px solid #1c2c44 !important;
    border-radius: 4px;
    font-size: 14px;
}
</style>
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-semibold text-tcsc-navy">Role Management</h1>
    <div class="flex gap-3">
        <a href="{{ url_for('admin.get_admin_page') }}" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-tcsc text-sm font-medium hover:bg-gray-300 transition-all">Back to Dashboard</a>
    </div>
</div>

<div class="bg-white rounded-tcsc p-5">
    <div class="flex items-center gap-3 mb-4">
        <button class="toolbar-btn toolbar-btn-primary" onclick="addNewRole()">Add New Role</button>
        <div class="ml-auto inline-flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 rounded-md text-sm font-medium text-gray-700">
            <span>Total:</span>
            <strong id="role-count" class="text-tcsc-navy">0</strong>
            <span>roles</span>
        </div>
    </div>

    <div id="roles-table" class="tabulator-config"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let rolesTable;
let rolesData = [];

const DEFAULT_GRADIENT = 'linear-gradient(135deg, #868e96 0%, #adb5bd 100%)';

document.addEventListener('DOMContentLoaded', async () => {
    // Fetch roles data
    const response = await fetch('/admin/tags/data');
    const data = await response.json();
    rolesData = data.tags;

    document.getElementById('role-count').textContent = rolesData.length;

    // Initialize Tabulator with inline editing
    rolesTable = new Tabulator("#roles-table", {
        data: rolesData,
        layout: "fitColumns",
        height: "calc(100vh - 320px)",

        columns: [
            {
                title: "Emoji",
                field: "emoji",
                width: 70,
                hozAlign: "center",
                editor: "input",
                formatter: function(cell) {
                    const emoji = cell.getValue() || '';
                    return `<span class="role-emoji-preview">${emoji || 'â€”'}</span>`;
                },
                cellEdited: function(cell) {
                    saveRole(cell.getRow().getData());
                }
            },
            {
                title: "Name",
                field: "name",
                minWidth: 140,
                editor: "input",
                validator: "required",
                cellEdited: function(cell) {
                    saveRole(cell.getRow().getData());
                }
            },
            {
                title: "Display Name",
                field: "display_name",
                minWidth: 140,
                editor: "input",
                validator: "required",
                cellEdited: function(cell) {
                    saveRole(cell.getRow().getData());
                }
            },
            {
                title: "Gradient",
                field: "gradient",
                minWidth: 200,
                editor: "input",
                formatter: function(cell) {
                    const gradient = cell.getValue() || DEFAULT_GRADIENT;
                    return `<span class="gradient-preview" style="background: ${gradient};" title="${gradient}"></span>`;
                },
                cellEdited: function(cell) {
                    saveRole(cell.getRow().getData());
                }
            },
            {
                title: "Users",
                field: "user_count",
                width: 80,
                hozAlign: "center",
                formatter: function(cell) {
                    const count = cell.getValue() || 0;
                    const cls = count > 0 ? 'user-count-badge has-users' : 'user-count-badge';
                    return `<span class="${cls}">${count}</span>`;
                }
            },
            {
                title: "Actions",
                width: 100,
                hozAlign: "center",
                formatter: function(cell) {
                    const data = cell.getRow().getData();
                    const canDelete = !data.user_count || data.user_count === 0;
                    const deleteBtn = canDelete
                        ? `<button class="tbl-btn tbl-btn-danger" onclick="deleteRole(${data.id}, '${data.display_name}')">Delete</button>`
                        : `<button class="tbl-btn tbl-btn-danger" disabled title="Cannot delete - has users">Delete</button>`;
                    return `<div class="tbl-actions">${deleteBtn}</div>`;
                },
                headerSort: false
            }
        ]
    });
});

async function saveRole(data) {
    // If no ID, this is a new role
    const url = data.id ? `/admin/tags/${data.id}/edit` : '/admin/tags/create';

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: data.name,
                display_name: data.display_name,
                emoji: data.emoji,
                gradient: data.gradient,
                description: data.description
            })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            // Update local data with returned tag (especially for new tags getting their ID)
            if (result.tag) {
                const idx = rolesData.findIndex(r => r.id === data.id || (!r.id && r.name === data.name));
                if (idx >= 0) {
                    rolesData[idx] = result.tag;
                    rolesTable.updateData([result.tag]);
                }
            }
            showToast('Role saved successfully', 'success');
        } else {
            showToast(result.error || 'Failed to save role', 'error');
            // Reload data to reset
            refreshData();
        }
    } catch (err) {
        showToast('Error saving role: ' + err.message, 'error');
        refreshData();
    }
}

async function deleteRole(id, name) {
    if (!confirm(`Delete role "${name}"?\n\nThis cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/admin/tags/${id}/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (response.ok && result.success) {
            showToast(result.message, 'success');
            refreshData();
        } else {
            showToast(result.error || 'Failed to delete role', 'error');
        }
    } catch (err) {
        showToast('Error deleting role: ' + err.message, 'error');
    }
}

function addNewRole() {
    // Add a new empty row at the top
    const newRole = {
        id: null,
        name: 'NEW_ROLE',
        display_name: 'New Role',
        emoji: '',
        gradient: '',
        user_count: 0
    };
    rolesTable.addRow(newRole, true);

    // Focus the name cell for editing
    setTimeout(() => {
        const rows = rolesTable.getRows();
        if (rows.length > 0) {
            rows[0].getCell('name').edit();
        }
    }, 100);
}

async function refreshData() {
    const response = await fetch('/admin/tags/data');
    const data = await response.json();
    rolesData = data.tags;
    rolesTable.setData(rolesData);
    document.getElementById('role-count').textContent = rolesData.length;
}
</script>
{% endblock %}
