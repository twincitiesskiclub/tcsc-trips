{% extends 'admin/admin_base.html' %}
{% block extra_css %}
<style>
/* Log output color classes */
.log-output .log-info {
    color: #60a5fa;
}

.log-output .log-success {
    color: #34d399;
}

.log-output .log-warning {
    color: #fbbf24;
}

.log-output .log-error {
    color: #f87171;
}

/* Toast animation */
.toast-notification {
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.toast-notification.show {
    opacity: 1;
    transform: translateX(0);
}

/* Loading state for buttons */
.admin-btn.loading {
    pointer-events: none;
}

.admin-btn.loading .btn-icon {
    display: none;
}

.admin-btn.loading .btn-text::after {
    content: '...';
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header with title and sync buttons -->
    <div class="flex flex-wrap justify-between items-center gap-3 mb-5">
        <h1 class="text-2xl font-semibold text-tcsc-navy m-0">Channel Sync</h1>
        <div class="flex items-center gap-3">
            <button class="admin-btn admin-btn-md admin-btn-secondary" id="dry-run-btn" onclick="runSync(true)">
                <span class="btn-icon">üîç</span>
                <span class="btn-text">Dry Run</span>
            </button>
            <button class="admin-btn admin-btn-md admin-btn-primary" id="live-run-btn" onclick="runSync(false)" style="background-color: #f59e0b;">
                <span class="btn-icon">‚ö°</span>
                <span class="btn-text">Live Run</span>
            </button>
        </div>
    </div>

    <!-- Status Cards -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
        <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-4 text-center min-h-[80px]" id="scheduler-card">
            <div class="text-2xl font-semibold text-tcsc-navy" id="stat-scheduler">-</div>
            <div class="text-sm text-tcsc-gray-600 mt-2">Scheduler</div>
        </div>
        <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-4 text-center min-h-[80px]" id="creds-card">
            <div class="text-2xl font-semibold text-tcsc-navy" id="stat-creds">-</div>
            <div class="text-sm text-tcsc-gray-600 mt-2">Admin API</div>
        </div>
        <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-4 text-center min-h-[80px]" id="mode-card">
            <div class="text-2xl font-semibold text-tcsc-navy" id="stat-mode">-</div>
            <div class="text-sm text-tcsc-gray-600 mt-2">Mode</div>
        </div>
        <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-4 text-center min-h-[80px]">
            <div class="text-2xl font-semibold text-tcsc-navy" id="stat-next-run">-</div>
            <div class="text-sm text-tcsc-gray-600 mt-2">Next Run</div>
        </div>
    </div>

    <!-- Configuration Section -->
    <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-5 mb-6">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-base font-semibold text-tcsc-navy m-0">Configuration</h3>
            <button class="admin-btn admin-btn-md admin-btn-secondary" onclick="loadStatus()">
                <span class="btn-icon">‚Üª</span>
                <span class="btn-text">Refresh</span>
            </button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="p-3 bg-gray-50 rounded-tcsc">
                <div class="text-xs text-tcsc-gray-600 mb-1 uppercase tracking-wide">Full Member Channels</div>
                <div class="text-sm font-medium text-tcsc-navy" id="config-full-member">-</div>
            </div>
            <div class="p-3 bg-gray-50 rounded-tcsc">
                <div class="text-xs text-tcsc-gray-600 mb-1 uppercase tracking-wide">Multi-Channel Guest</div>
                <div class="text-sm font-medium text-tcsc-navy" id="config-mcg">-</div>
            </div>
            <div class="p-3 bg-gray-50 rounded-tcsc">
                <div class="text-xs text-tcsc-gray-600 mb-1 uppercase tracking-wide">Single-Channel Guest</div>
                <div class="text-sm font-medium text-tcsc-navy" id="config-scg">-</div>
            </div>
            <div class="p-3 bg-gray-50 rounded-tcsc">
                <div class="text-xs text-tcsc-gray-600 mb-1 uppercase tracking-wide">Exception Tags</div>
                <div class="text-sm font-medium text-tcsc-navy" id="config-tags">-</div>
            </div>
        </div>
    </div>

    <!-- ExpertVoice Section -->
    <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-5 mb-6">
        <div class="flex flex-wrap justify-between items-center mb-5 gap-3">
            <h3 class="text-base font-semibold text-tcsc-navy m-0">ExpertVoice Sync</h3>
            <div class="flex items-center gap-3">
                <button class="admin-btn admin-btn-md admin-btn-secondary" id="ev-dry-run-btn" onclick="runExpertVoice(true)">
                    <span class="btn-icon">üîç</span>
                    <span class="btn-text">Dry Run</span>
                </button>
                <button class="admin-btn admin-btn-md admin-btn-primary" id="ev-live-btn" onclick="runExpertVoice(false)" style="background-color: #10b981;">
                    <span class="btn-icon">üì§</span>
                    <span class="btn-text">Upload</span>
                </button>
            </div>
        </div>
        <p class="text-tcsc-gray-600 text-sm m-0">
            Syncs eligible members (ACTIVE + 1-season ALUMNI) to ExpertVoice via SFTP for pro deals access.
        </p>
    </div>

    <!-- Results Section -->
    <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-5 mb-6 hidden" id="results-section">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-base font-semibold text-tcsc-navy m-0">Last Sync Results</h3>
            <span class="inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-sm font-medium" id="results-mode">-</span>
        </div>
        <div id="results-content"></div>
    </div>

    <!-- Log Output -->
    <div class="bg-white border border-tcsc-gray-100 rounded-tcsc p-5 mb-6">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-base font-semibold text-tcsc-navy m-0">Activity Log</h3>
            <button class="admin-btn admin-btn-md admin-btn-secondary" onclick="clearLog()">
                <span class="btn-icon">üóë</span>
                <span class="btn-text">Clear</span>
            </button>
        </div>
        <div class="log-output bg-gray-900 text-gray-100 p-4 rounded-tcsc font-mono text-sm leading-relaxed max-h-96 overflow-y-auto whitespace-pre-wrap break-words" id="log-output">Waiting for activity...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Log helper
function log(message, level = 'info') {
    const logEl = document.getElementById('log-output');
    const timestamp = new Date().toLocaleTimeString();
    const levelClass = `log-${level}`;
    logEl.innerHTML += `<span class="${levelClass}">[${timestamp}] ${message}</span>\n`;
    logEl.scrollTop = logEl.scrollHeight;
}

function clearLog() {
    document.getElementById('log-output').innerHTML = '';
}

// Toast notifications
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    let bgClass = 'bg-blue-100 text-blue-800';
    if (type === 'success') bgClass = 'bg-green-100 text-green-800';
    if (type === 'error') bgClass = 'bg-red-100 text-red-800';
    toast.className = `toast-notification fixed top-5 right-5 px-5 py-3 rounded-tcsc font-medium text-sm z-[2000] max-w-[calc(100%-40px)] ${bgClass}`;
    toast.textContent = message;
    document.body.appendChild(toast);

    requestAnimationFrame(() => toast.classList.add('show'));

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Load status
async function loadStatus() {
    try {
        log('Loading status...');
        const response = await fetch('/admin/channel-sync/status');
        const data = await response.json();

        if (data.error) {
            log(`Error: ${data.error}`, 'error');
            showToast(data.error, 'error');
            return;
        }

        // Update scheduler status
        const schedulerCard = document.getElementById('scheduler-card');
        const schedulerStat = document.getElementById('stat-scheduler');
        if (data.scheduler.running) {
            schedulerStat.textContent = '‚úì Running';
            schedulerStat.className = 'text-2xl font-semibold text-green-600';
        } else {
            schedulerStat.textContent = '‚úó Stopped';
            schedulerStat.className = 'text-2xl font-semibold text-red-600';
        }

        // Update next run time
        if (data.scheduler.jobs && data.scheduler.jobs.length > 0) {
            const nextRun = new Date(data.scheduler.jobs[0].next_run);
            document.getElementById('stat-next-run').textContent = nextRun.toLocaleString();
        } else {
            document.getElementById('stat-next-run').textContent = 'Not scheduled';
        }

        // Update credentials status
        const credsStat = document.getElementById('stat-creds');
        if (data.credentials.valid) {
            credsStat.textContent = '‚úì Valid';
            credsStat.className = 'text-2xl font-semibold text-green-600';
        } else {
            credsStat.textContent = '‚úó Invalid';
            credsStat.className = 'text-2xl font-semibold text-red-600';
            log(`Credential error: ${data.credentials.error}`, 'error');
        }

        // Update mode
        const modeStat = document.getElementById('stat-mode');
        if (data.config.dry_run) {
            modeStat.textContent = 'Dry Run';
            modeStat.className = 'text-2xl font-semibold text-amber-600';
        } else {
            modeStat.textContent = 'LIVE';
            modeStat.className = 'text-2xl font-semibold text-green-600';
        }

        // Update config info
        document.getElementById('config-full-member').textContent =
            `${data.config.channels.full_member} channels`;
        document.getElementById('config-mcg').textContent =
            `${data.config.channels.multi_channel_guest} channels`;
        document.getElementById('config-scg').textContent =
            `${data.config.channels.single_channel_guest} channels`;
        document.getElementById('config-tags').textContent =
            data.config.exception_tags.join(', ') || 'None';

        log('Status loaded successfully', 'success');

    } catch (error) {
        log(`Failed to load status: ${error.message}`, 'error');
        showToast('Failed to load status', 'error');
    }
}

// Animate loading dots
function animateLoadingDots(btn) {
    const textEl = btn.querySelector('.btn-text');
    if (!textEl) return null;
    const originalText = textEl.textContent;
    let dots = 0;
    const interval = setInterval(() => {
        dots = (dots + 1) % 4;
        textEl.textContent = originalText + '.'.repeat(dots);
    }, 300);
    return { interval, textEl, originalText };
}

function stopLoadingAnimation(animation) {
    if (animation) {
        clearInterval(animation.interval);
        animation.textEl.textContent = animation.originalText;
    }
}

// Run channel sync (now runs in background)
async function runSync(dryRun) {
    const btn = dryRun ? document.getElementById('dry-run-btn') : document.getElementById('live-run-btn');
    btn.classList.add('loading');
    btn.disabled = true;
    const animation = animateLoadingDots(btn);

    // Disable both buttons during sync
    document.getElementById('dry-run-btn').disabled = true;
    document.getElementById('live-run-btn').disabled = true;

    const modeText = dryRun ? 'DRY RUN' : 'LIVE';
    log(`Starting ${modeText} channel sync...`, 'info');

    try {
        // Start the sync (returns immediately)
        const response = await fetch('/admin/channel-sync/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dry_run: dryRun })
        });

        const startData = await response.json();

        if (startData.status === 'already_running') {
            log('A sync is already in progress...', 'warning');
            showToast('Sync already running', 'warning');
        } else if (startData.status === 'started') {
            log('Sync started in background, polling for results...', 'info');
        } else if (startData.error) {
            log(`Error: ${startData.error}`, 'error');
            showToast(startData.error, 'error');
            return;
        }

        // Poll for results
        await pollForResults(modeText);

    } catch (error) {
        log(`Failed: ${error.message}`, 'error');
        showToast('Sync failed', 'error');
    } finally {
        stopLoadingAnimation(animation);
        btn.classList.remove('loading');
        document.getElementById('dry-run-btn').disabled = false;
        document.getElementById('live-run-btn').disabled = false;
    }
}

// Poll for sync results
async function pollForResults(modeText) {
    const maxAttempts = 120; // 2 minutes max (120 * 1 second)
    let attempts = 0;

    while (attempts < maxAttempts) {
        attempts++;

        try {
            const response = await fetch('/admin/channel-sync/result');
            const data = await response.json();

            if (data.status === 'running') {
                if (attempts % 5 === 0) {
                    log(`Still running... (${attempts}s)`, 'info');
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
                continue;
            }

            if (data.status === 'error') {
                log(`Sync failed: ${data.error}`, 'error');
                showToast('Sync failed', 'error');
                return;
            }

            if (data.status === 'completed') {
                // Display results
                displayResults(data, 'slack');

                // Log summary
                const s = data.slack_sync;
                log(`${modeText} complete:`, 'success');
                log(`  Processed: ${s.total_processed} users`);
                log(`  Role changes: ${s.role_changes}`);
                log(`  Channel adds: ${s.channel_adds}`);
                log(`  Channel removals: ${s.channel_removals}`);
                log(`  Invites sent: ${s.invites_sent}`);
                log(`  Skipped: ${s.users_skipped}`);

                if (s.error_count > 0) {
                    log(`  Errors: ${s.error_count}`, 'warning');
                    s.errors.forEach(err => log(`    - ${err}`, 'error'));
                }

                showToast(`${modeText} sync complete`, 'success');
                return;
            }

            // Unexpected status
            log(`Unexpected status: ${data.status}`, 'warning');
            return;

        } catch (error) {
            log(`Polling error: ${error.message}`, 'error');
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }

    log('Sync timed out after 2 minutes', 'error');
    showToast('Sync timed out', 'error');
}

// Run ExpertVoice sync
async function runExpertVoice(dryRun) {
    const btn = dryRun ? document.getElementById('ev-dry-run-btn') : document.getElementById('ev-live-btn');
    btn.classList.add('loading');
    btn.disabled = true;
    const animation = animateLoadingDots(btn);

    const modeText = dryRun ? 'DRY RUN' : 'LIVE';
    log(`Starting ExpertVoice ${modeText}...`, 'info');

    try {
        const response = await fetch('/admin/channel-sync/expertvoice', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dry_run: dryRun })
        });

        const data = await response.json();

        if (data.error) {
            log(`Error: ${data.error}`, 'error');
            showToast(data.error, 'error');
            return;
        }

        // Log summary
        log(`ExpertVoice ${modeText} complete:`, 'success');
        log(`  Members synced: ${data.members_synced}`);
        log(`  Active: ${data.active_members}`);
        log(`  Alumni: ${data.alumni_members}`);
        log(`  Uploaded: ${data.uploaded ? 'Yes' : 'No (dry run)'}`);

        if (data.errors && data.errors.length > 0) {
            data.errors.forEach(err => log(`  Error: ${err}`, 'error'));
        }

        showToast(`ExpertVoice ${modeText} complete`, 'success');

    } catch (error) {
        log(`Failed: ${error.message}`, 'error');
        showToast('ExpertVoice sync failed', 'error');
    } finally {
        stopLoadingAnimation(animation);
        btn.classList.remove('loading');
        btn.disabled = false;
    }
}

// Display results
function displayResults(data, type) {
    const section = document.getElementById('results-section');
    const content = document.getElementById('results-content');
    const badge = document.getElementById('results-mode');

    section.classList.remove('hidden');
    badge.textContent = data.dry_run ? 'Dry Run' : 'Live';
    badge.className = `inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-sm font-medium ${data.dry_run ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'}`;

    if (type === 'slack' && data.slack_sync) {
        const s = data.slack_sync;
        let html = `
            <table class="w-full border-collapse mt-4 mb-4">
                <tr><th class="bg-gray-50 font-semibold text-sm text-tcsc-gray-600 px-3 py-2.5 text-left border-b border-tcsc-gray-100">Metric</th><th class="bg-gray-50 font-semibold text-sm text-tcsc-gray-600 px-3 py-2.5 text-left border-b border-tcsc-gray-100">Value</th></tr>
                <tr><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">Users Processed</td><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">${s.total_processed}</td></tr>
                <tr><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">Reactivated Users</td><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">${s.reactivated_users}</td></tr>
                <tr><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">Role Changes</td><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">${s.role_changes}</td></tr>
                <tr><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">Channel Adds</td><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">${s.channel_adds}</td></tr>
                <tr><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">Channel Removals</td><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">${s.channel_removals}</td></tr>
                <tr><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">Invites Sent</td><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">${s.invites_sent}</td></tr>
                <tr><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">Users Skipped</td><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">${s.users_skipped}</td></tr>
                <tr><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">Errors</td><td class="text-sm px-3 py-2.5 border-b border-tcsc-gray-100">${s.error_count}</td></tr>
            </table>
        `;

        // Display action traces if any
        if (s.traces && s.traces.length > 0) {
            html += `
                <h4 class="mt-5 mb-3 text-tcsc-navy text-sm font-semibold">
                    Action Traces (${s.traces.length})
                </h4>
                <div class="log-output bg-gray-900 text-gray-100 p-4 rounded-tcsc font-mono text-sm leading-relaxed max-h-96 overflow-y-auto whitespace-pre-wrap break-words">`;
            s.traces.forEach(trace => {
                // Color-code by action type
                let levelClass = 'log-info';
                if (trace.startsWith('ROLE_CHANGE:')) levelClass = 'log-warning';
                else if (trace.startsWith('REACTIVATE:')) levelClass = 'log-success';
                else if (trace.startsWith('INVITE:')) levelClass = 'log-success';
                else if (trace.startsWith('CHANNEL_REMOVE:')) levelClass = 'log-error';
                html += `<span class="${levelClass}">${trace}</span>\n`;
            });
            html += '</div>';
        }

        content.innerHTML = html;
    }
}

// Load status on page load
document.addEventListener('DOMContentLoaded', loadStatus);
</script>
{% endblock %}
